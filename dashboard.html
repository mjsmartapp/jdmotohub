<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JD MotoHub</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, updateProfile } 
      from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js"; // Added updateProfile
    import { getDatabase, ref, push, onValue, set, query, orderByChild, equalTo, get } 
      from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js"; // Added get

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBuTQZ0zwLMLdfzzD2KjEhaGk6BTzJK72s",
      authDomain: "secondhand-803a3.firebaseapp.com",
      databaseURL: "https://secondhand-803a3-default-rtdb.firebaseio.com/",
      projectId: "secondhand-803a3",
      storageBucket: "secondhand-803a3.firebasestorage.app",
      messagingSenderId: "554970268999",
      appId: "1:554970268999:web:d4f418e31c65ef8599f862",
      measurementId: "G-8D44TJDZ24"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUserId = null; 
    let currentUserEmail = null; 
    let currentUserPhone = null; // NEW: Store current user's phone
    let currentUserAddress = null; // NEW: Store current user's address
    let cartCount = 0; 

    // üîπ Utility Functions for Loader Bar
    const loader = document.getElementById('loader-bar');
    window.showLoader = () => { loader.style.display = 'block'; };
    window.hideLoader = () => { loader.style.display = 'none'; };

    // üîπ Toast Notification Function (Top Center)
    window.showToast = (message, type = 'success') => {
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        document.body.appendChild(toastContainer);
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerText = message;
      toastContainer.prepend(toast);

      setTimeout(() => {
        toast.classList.add('fade-out');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 3000); 
    };

    // üõí Load Cart Count from Firebase
    function loadCartCount() {
        if (!currentUserId) return;

        // Listen for real-time changes to the user's cart node
        onValue(ref(db, `users/${currentUserId}/cart`), (snapshot) => {
            const cartItems = snapshot.val();
            cartCount = cartItems ? Object.keys(cartItems).length : 0;
            document.getElementById('cart-count').innerText = cartCount;
        }, {
            onlyOnce: false // Keep listening for changes
        });
    }

    // üõí Add Vehicle to Cart in Firebase
    window.addToCart = async (vehicleKey, vehicleName) => {
        if (!currentUserId) {
            return showToast("Please log in to add items to your cart.", "error");
        }

        try {
            // Set the item in the cart (using set to ensure the key is the vehicle ID)
            await set(ref(db, `users/${currentUserId}/cart/${vehicleKey}`), true);

            showToast(`${vehicleName} added to cart! Total items: ${cartCount + 1}`, "success");
            // loadCartCount handles the UI update via onValue listener
        } catch (err) {
            showToast(`Error adding to cart: ${err.message}`, "error");
        }
    };

    // üì¶ Simulate a Direct Purchase (Log as Order) - MODIFIED
    window.buyVehicle = async (vehicleKey, vehicleName, price) => {
        if (!currentUserId) {
            return showToast("Please log in to place an order.", "error");
        }

        // ‚≠ê NEW: Check for required Mobile Number
        if (!currentUserPhone || currentUserPhone.length < 10) {
            showToast("Mobile Number is required to place an order. Please update your profile.", "error");
            showSection('profile'); // Redirect to profile view
            return;
        }

        showLoader(); // Show loader during purchase

        try {
            const orderRef = push(ref(db, `users/${currentUserId}/orders`));
            await set(orderRef, {
                vehicleKey: vehicleKey,
                vehicleName: vehicleName,
                price: price,
                timestamp: new Date().toISOString(),
                status: "processing",
                // Include current contact info for the order record
                buyerInfo: { 
                    name: auth.currentUser.displayName,
                    email: currentUserEmail,
                    phone: currentUserPhone,
                    address: currentUserAddress || 'Not Provided'
                }
            });
            showToast(`Order placed for ${vehicleName} (‚Çπ${parseInt(price).toLocaleString('en-IN')})!`, "success");
        } catch (err) {
            showToast(`Error placing order: ${err.message}`, "error");
        } finally {
            hideLoader(); // Hide loader after completion
        }
    };


    // üõí NEW: Load Cart Items
    window.loadCartItems = () => {
        const cartList = document.getElementById("cartItemsList");
        const cartSummary = document.getElementById("cartSummary");
        cartList.innerHTML = ''; // Clear previous content
        let totalCartPrice = 0;
        let itemsInCart = 0;

        if (!currentUserId) {
            document.getElementById('cart-count-display').innerText = 0;
            cartList.innerHTML = '<p class="empty-state">Please log in to view your shopping cart.</p>';
            cartSummary.innerHTML = '<p class="total-price-text">Total: <span>‚Çπ0</span></p>';
            document.getElementById('checkoutButton').disabled = true;
            return;
        }

        const cartRef = ref(db, `users/${currentUserId}/cart`);
        // Use an onValue listener to react to real-time changes
        onValue(cartRef, async (snapshot) => {
            const cartKeys = snapshot.val();
            itemsInCart = cartKeys ? Object.keys(cartKeys).length : 0;
            document.getElementById('cart-count-display').innerText = itemsInCart;
            cartList.innerHTML = '';
            totalCartPrice = 0;

            if (itemsInCart === 0) {
                cartList.innerHTML = '<p class="empty-state">Your cart is empty. Start shopping!</p>';
                cartSummary.innerHTML = '<p class="total-price-text">Total: <span>‚Çπ0</span></p>';
                document.getElementById('checkoutButton').disabled = true;
                return;
            }

            document.getElementById('checkoutButton').disabled = false;

            // Fetch details for each cart item
            const vehiclePromises = Object.keys(cartKeys).map(key => new Promise((resolve, reject) => {
                // Fetch vehicle details only once to get current price/details
                onValue(ref(db, `vehicles/${key}`), (vehicleSnapshot) => {
                    const v = vehicleSnapshot.val();
                    if (v && v.status === 'approved') {
                        v.key = vehicleSnapshot.key;
                        resolve(v);
                    } else {
                        // Item might have been removed or unapproved
                        resolve(null); 
                    }
                }, { onlyOnce: true });
            }));

            const vehicles = (await Promise.all(vehiclePromises)).filter(v => v !== null);

            vehicles.forEach(v => {
                const displayPrice = v.adminPrice || v.price || 0;
                const formattedPrice = parseInt(displayPrice).toLocaleString('en-IN');
                totalCartPrice += parseInt(displayPrice);

                const cartItem = document.createElement("div");
                cartItem.className = "cart-item-card";
                cartItem.innerHTML = `
                    <div class="item-image" style="background-image: url('${v.img}');"></div>
                    <div class="item-details">
                        <h3>${v.name}</h3>
                        <p class="item-specs">Year: ${v.year} | ${v.km} km</p>
                    </div>
                    <p class="item-price">‚Çπ${formattedPrice}</p>
                    <div class="item-actions">
                        <button class="remove-btn" onclick="removeFromCart('${v.key}', '${v.name}')">Remove</button>
                    </div>
                `;
                cartList.appendChild(cartItem);
            });

            cartSummary.innerHTML = `<p class="total-price-text">Subtotal: <span>‚Çπ${totalCartPrice.toLocaleString('en-IN')}</span></p>
                                     <p class="total-price-text">Tax: <span>‚Çπ0</span></p>
                                     <div style="border-top: 1px solid var(--border-color); margin-top: 10px; padding-top: 10px;">
                                        <p class="total-price-text">Total: <span style="font-size: 26px;">‚Çπ${totalCartPrice.toLocaleString('en-IN')}</span></p>
                                     </div>`;

        }, { onlyOnce: false }); // Keep listening for changes (e.g., if another tab adds an item)
    };

    // üõí NEW: Remove item from cart
    window.removeFromCart = async (vehicleKey, vehicleName) => {
        if (!currentUserId) return;
        try {
            await set(ref(db, `users/${currentUserId}/cart/${vehicleKey}`), null);
            showToast(`${vehicleName} removed from cart.`, "success");
        } catch (err) {
            showToast(`Error removing item: ${err.message}`, "error");
        }
    };

    // üí∞ NEW: Simulate Checkout (Modified to check for phone number)
    window.checkoutCart = async () => {
        if (!currentUserId) return;

        // ‚≠ê NEW: Check for required Mobile Number for checkout too
        if (!currentUserPhone || currentUserPhone.length < 10) {
            showToast("Mobile Number is required for checkout. Please update your profile.", "error");
            showSection('profile'); // Redirect to profile view
            return;
        }

        showLoader(); // Show loader during checkout

        try {
            // For a real app, you would move items to orders, handle payment, etc.
            // Here, we simulate by logging the event and clearing the cart.
            await set(ref(db, `users/${currentUserId}/cart`), null);
            showToast("Checkout Successful! Your order has been placed and is being processed.", "success");
            showSection('order'); // Redirect user to orders page
        } catch (err) {
            showToast(`Error during checkout: ${err.message}`, "error");
        } finally {
            hideLoader();
        }
    }


    // üì¶ NEW: Load Orders History
    window.loadOrdersHistory = () => {
        const ordersTableBody = document.getElementById("ordersTableBody");
        ordersTableBody.innerHTML = '<tr><td colspan="5">Loading your orders...</td></tr>';

        if (!currentUserId) {
            ordersTableBody.innerHTML = '<tr><td colspan="5">Please log in to view your order history.</td></tr>';
            return;
        }

        // Listen for user's orders
        onValue(ref(db, `users/${currentUserId}/orders`), (snapshot) => {
            ordersTableBody.innerHTML = "";
            let recordsFound = 0;
            const orders = [];

            snapshot.forEach((child) => {
                const order = child.val();
                order.orderId = child.key;
                orders.push(order);
            });

            // Sort by timestamp (newest first)
            orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            orders.forEach((order) => {
                recordsFound++;
                const formattedPrice = parseInt(order.price || 0).toLocaleString('en-IN');
                // Format date nicely
                const orderDate = new Date(order.timestamp).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                let statusClass = '';
                let statusText = order.status;

                if (order.status === 'processing') {
                    statusClass = 'pending'; 
                } else if (order.status === 'shipped') {
                    statusClass = 'approved'; 
                } else if (order.status === 'delivered') {
                    statusClass = 'approved'; 
                    statusText = 'Delivered';
                } else if (order.status === 'cancelled') {
                    statusClass = 'rejected';
                }

                const row = `
                    <tr>
                        <td data-label="Order ID">#${order.orderId.substring(0, 8).toUpperCase()}</td>
                        <td data-label="Vehicle">${order.vehicleName}</td>
                        <td data-label="Price">‚Çπ${formattedPrice}</td>
                        <td data-label="Date">${orderDate}</td>
                        <td data-label="Status"><span class="status-badge ${statusClass}">${statusText.charAt(0).toUpperCase() + statusText.slice(1)}</span></td>
                    </tr>
                `;
                ordersTableBody.insertAdjacentHTML("beforeend", row);
            });

            if (recordsFound === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="5">You have no orders yet. Click "Buy Now" on a vehicle to place an order.</td></tr>';
            }
        }, (error) => {
            console.error("Error loading order history:", error);
            ordersTableBody.innerHTML = '<tr><td colspan="5">Error loading order history.</td></tr>';
        });
    };

    // ‚≠ê NEW: Function to load and set user profile data from DB
    async function loadUserProfile(user) {
        try {
            const profileSnapshot = await get(ref(db, `users/${user.uid}/profile`));
            const profileData = profileSnapshot.val();

            // Set global user variables
            currentUserPhone = profileData?.phone || null;
            currentUserAddress = profileData?.address || null;

            // Set Profile View fields
            document.getElementById("profile-input-name").value = user.displayName || "";
            document.getElementById("profile-input-phone").value = currentUserPhone || "";
            document.getElementById("profile-input-address").value = currentUserAddress || "";
            document.getElementById("profile-input-email").value = user.email || ""; // Readonly email

            // Set display fields
            document.getElementById("userNameProfile").innerText = user.displayName || "User";
            document.getElementById("userEmailProfile").innerText = user.email;
            document.getElementById("userPhoneProfile").innerText = currentUserPhone || "N/A (Required for Orders)";
            document.getElementById("userAddressProfile").innerText = currentUserAddress || "N/A";

        } catch (error) {
            console.error("Error loading user profile:", error);
        }
    }

    // ‚≠ê NEW: Function to update user profile data in Auth and DB
    window.updateUserProfile = async () => {
        if (!currentUserId) return;

        const newName = document.getElementById("profile-input-name").value.trim();
        const newPhone = document.getElementById("profile-input-phone").value.trim();
        const newAddress = document.getElementById("profile-input-address").value.trim();

        if (!newName || !newPhone || newPhone.length < 10) {
            return showToast("Name and a valid Mobile Number are required!", "warning");
        }

        showLoader();

        try {
            // 1. Update Firebase Authentication Profile (for display name)
            await updateProfile(auth.currentUser, {
                displayName: newName
            });

            // 2. Update Realtime Database Profile (for phone, address, etc.)
            const profileData = {
                name: newName,
                phone: newPhone,
                address: newAddress,
                lastUpdated: new Date().toISOString()
            };
            await set(ref(db, `users/${currentUserId}/profile`), profileData);

            // Update local variables and re-run UI updates
            await loadUserProfile(auth.currentUser); 

            // Re-populate sell form fields
            document.getElementById("selleremail").value = auth.currentUser.email;
            document.getElementById("sellername").value = newName;
            document.getElementById("sellerphone").value = newPhone;


            showToast("Profile updated successfully!", "success");

        } catch (error) {
            showToast(`Error updating profile: ${error.message}`, "error");
        } finally {
            hideLoader();
        }
    };


    // üîí Protect Dashboard & Load User Info - MODIFIED
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index.html";
      } else {
        currentUserId = user.uid; // Store UID
        currentUserEmail = user.email; 

        // Load the persistent cart count AND the profile data
        loadCartCount();
        loadUserProfile(user); 

        // Drawer Profile content
        document.getElementById("userPhotoDrawer").src = user.photoURL || "https://static-00.iconduck.com/assets.00/user-avatar-icon-512x512-nghi2896.png";
        document.getElementById("userNameDrawer").innerText = user.displayName || "User";
        document.getElementById("userEmailDrawer").innerText = user.email;


        // Pre-fill seller details on the Sell page (will be overwritten by loadUserProfile)
        document.getElementById("selleremail").value = user.email;
        document.getElementById("sellername").value = user.displayName || "";
      }
    });

    // üîπ Logout Function
    window.logout = () => {
      signOut(auth).then(() => {
        showToast("Logged out successfully.", "success");
        window.location.href = "index.html";
      });
    };

    //
    // --- NEW IMAGE PICKER + PREVIEW LOGIC (Base64 conversion, no Firebase Storage) ---
    //
    // We'll keep selectedImages as an array of objects: { id, src, kind } where kind is 'file' or 'url'
    //
    const selectedImages = [];
    let imageIdCounter = 0;

    // Handle files selected from file input -> convert to dataURL (Base64) and add to selectedImages
    window.handleFileSelection = (event) => {
      const files = Array.from(event.target.files || []);
      if (files.length === 0) return;
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          selectedImages.push({ id: `img_${imageIdCounter++}`, src: e.target.result, kind: 'file' });
          renderImagePreviews();
        };
        reader.readAsDataURL(file);
      });
      // clear file input so same file can be re-selected if needed
      event.target.value = "";
    };

    // Add image URLs entered manually (comma separated) into selectedImages as kind: 'url'
    window.addImageURLsToSelection = () => {
      const urlInput = document.getElementById("vimages").value.trim();
      if (!urlInput) return;
      const urls = urlInput.split(",").map(u => u.trim()).filter(u => u !== "");
      urls.forEach(u => selectedImages.push({ id: `img_${imageIdCounter++}`, src: u, kind: 'url' }));
      document.getElementById("vimages").value = "";
      renderImagePreviews();
    };

    // Remove image by id
    window.removeSelectedImage = (id) => {
      const idx = selectedImages.findIndex(i => i.id === id);
      if (idx !== -1) {
        selectedImages.splice(idx, 1);
        renderImagePreviews();
      }
    };

    // Render preview thumbnails with remove button
    function renderImagePreviews() {
      const container = document.getElementById("imagePreviewContainer");
      if (!container) return;
      container.innerHTML = "";
      selectedImages.forEach(img => {
        const wrapper = document.createElement("div");
        wrapper.className = "preview-wrapper";
        wrapper.innerHTML = `
          <img src="${img.src}" alt="preview" loading="lazy" />
          <button type="button" class="preview-remove" onclick="removeSelectedImage('${img.id}')">‚úï</button>
          <div class="preview-kind">${img.kind === 'file' ? 'file' : 'url'}</div>
        `;
        container.appendChild(wrapper);
      });
    }

    //
    // üîπ Add Vehicle (sent to pending approval) - UPDATED to combine selectedImages + manual input
    //
    window.addVehicle = () => {
      // Seller Details
      const sellerName = document.getElementById("sellername").value.trim();
      const sellerEmail = document.getElementById("selleremail").value.trim();
      const sellerPhone = document.getElementById("sellerphone").value.trim();
      const sellerAltPhone = document.getElementById("selleraltphone").value.trim();
      const sellerAddress = document.getElementById("selleraddress").value.trim();

      // Vehicle Details
      const name = document.getElementById("vname").value.trim();
      const description = document.getElementById("vdescription").value.trim(); 
      const type = document.getElementById("vtype").value;
      const year = document.getElementById("vyear").value.trim();
      const km = document.getElementById("vkm").value.trim();
      const price = document.getElementById("vprice").value.trim();

      // Also allow user to quickly add any remaining URLs into selection before submit
      addImageURLsToSelection();

      // Build combined vimages string from selectedImages (preserve order)
      const combinedImageSrcs = selectedImages.map(i => i.src);
      const imagesInput = combinedImageSrcs.join(","); 
      const img = combinedImageSrcs[0] || "https://images.unsplash.com/photo-1596557802874-954848074902?fit=crop&w=600&h=300&q=80";


      // Updated validation check
      if (!sellerName || !sellerEmail || !sellerPhone || !sellerAddress || !name || !description || !year || !km || !price) {
        showToast("Please fill all required fields (Seller and Vehicle details)!", "warning");
        return;
      }

      if (combinedImageSrcs.length === 0) {
        showToast("Please add at least one image URL or file before submitting.", "warning");
        return;
      }

      const vehicleData = {
        // Seller Information Structure
        seller: {
            name: sellerName,
            email: sellerEmail,
            phone: sellerPhone,
            altPhone: sellerAltPhone,
            address: sellerAddress
        },
        // Vehicle Information
        name,
        description, 
        type,
        year,
        km,
        price,
        img, 
        vimages: imagesInput, 
        status: "pending",
        submittedBy: currentUserEmail 
      };

      showLoader();
      push(ref(db, "vehicles/"), vehicleData)
        .then(() => {
          showToast("Vehicle submitted for admin approval!", "success");
          // Clear form fields
          document.querySelectorAll("#sell-view input, #sell-view textarea").forEach(i => i.value = "");
          document.getElementById("vtype").value = "bike";
          // Clear previews
          selectedImages.length = 0;
          renderImagePreviews();
          // Re-populate seller details
          if(auth.currentUser) {
              document.getElementById("selleremail").value = auth.currentUser.email;
              document.getElementById("sellername").value = auth.currentUser.displayName || "";
          }
          showSection('history'); // Show sell history after submission
        })
        .catch((err) => {
          showToast(`Error submitting vehicle: ${err.message}`, "error");
        })
        .finally(() => {
          hideLoader();
        });
    };

    // üîπ Load Approved Vehicles (Home View) - UNCHANGED
    const vehicleGrid = document.getElementById("vehicleGrid");
    onValue(ref(db, "vehicles/"), (snapshot) => {
      vehicleGrid.innerHTML = "";
      const vehicles = [];
      snapshot.forEach((child) => {
        const v = child.val();
        const vehicleKey = child.key; 
        if (v.status === "approved") {
          // Use adminPrice as the final approved selling price, falling back to original price.
          const displayPrice = v.adminPrice || v.price || 0; 
          
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.type = v.type;
          // Store searchable/sortable data in data-attributes
          card.dataset.name = v.name;
          card.dataset.year = v.year;
          card.dataset.km = v.km;
          card.dataset.price = displayPrice; // Store raw price for search/sort
          
          card.innerHTML = `
            <div class="card-image" style="background-image: url('${v.img}');"></div>
            <div class="card-content">
              <h3>${v.name}</h3>
              <p class="specs">Year: <span>${v.year}</span> | ${v.km} <span>km</span></p>
              <p class="description">${(v.description || 'No description provided.').substring(0, 50)}...</p>
              <div class="card-actions">
                <p class="price">‚Çπ${parseInt(displayPrice).toLocaleString('en-IN')}</p>
                <div class="action-buttons">
                    <button class="cart-btn" onclick="addToCart('${vehicleKey}', '${v.name}')">
                        üõí Add
                    </button>
                    <button class="buy-btn" onclick="buyVehicle('${vehicleKey}', '${v.name}', '${displayPrice}')">
                        Buy Now
                    </button>
                </div>
              </div>
            </div>
          `;
          vehicles.push(card);
        }
      });
      // Append all cards before filtering/sorting
      vehicles.forEach(card => vehicleGrid.appendChild(card));

      // Re-run filter/sort on new data load
      filterVehicles(); 
    });

    // üîπ Load Sell History - UNCHANGED
    window.loadSellHistory = async () => {
        const historyTableBody = document.getElementById("historyTableBody");
        historyTableBody.innerHTML = "<tr><td colspan='6'>Loading your history...</td></tr>";

        if (!currentUserEmail) {
            historyTableBody.innerHTML = "<tr><td colspan='6'>Please log in to see your history.</td></tr>";
            return;
        }

        try {
            // Query vehicles submitted by the current user
            const userHistoryQuery = query(ref(db, "vehicles/"), orderByChild("submittedBy"), equalTo(currentUserEmail));

            onValue(userHistoryQuery, (snapshot) => {
                historyTableBody.innerHTML = "";
                let recordsFound = 0;

                snapshot.forEach((child) => {
                    const v = child.val();
                    recordsFound++;

                    let statusClass = '';
                    let statusText = '';
                    let finalPrice = v.price ? parseInt(v.price).toLocaleString('en-IN') : 'N/A';

                    if (v.status === 'approved') {
                        statusClass = 'approved';
                        statusText = 'Approved';
                        finalPrice = v.adminPrice ? parseInt(v.adminPrice).toLocaleString('en-IN') : finalPrice;
                    } else if (v.status === 'pending') {
                        statusClass = 'pending';
                        statusText = 'Pending Admin Review';
                    } else if (v.status === 'rejected') {
                        statusClass = 'rejected';
                        statusText = 'Rejected by Admin';
                    } else {
                        statusClass = 'unknown';
                        statusText = 'Unknown Status';
                    }

                    const row = `
                        <tr>
                            <td data-label="Vehicle Name">${v.name}</td>
                            <td data-label="Type">${v.type}</td>
                            <td data-label="Your Price">‚Çπ${parseInt(v.price || 0).toLocaleString('en-IN')}</td>
                            <td data-label="Final Price">‚Çπ${finalPrice}</td>
                            <td data-label="Status"><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td data-label="Action"><button class="action-btn view-details-btn" onclick="showToast('Details for ${v.name} - Status: ${statusText}', 'success')">View Details</button></td>
                        </tr>
                    `;
                    historyTableBody.insertAdjacentHTML("beforeend", row);
                });

                if (recordsFound === 0) {
                    historyTableBody.innerHTML = "<tr><td colspan='6'>You have not submitted any vehicles yet.</td></tr>";
                }
            }, (error) => {
                console.error("Error loading sell history:", error);
                historyTableBody.innerHTML = "<tr><td colspan='6'>Error loading history.</td></tr>";
            });

        } catch (err) {
            console.error("Error during history query setup:", err);
            historyTableBody.innerHTML = "<tr><td colspan='6'>An error occurred.</td></tr>";
        }
    };


    // üîπ Drawer Toggle Function
    window.toggleDrawer = () => {
        const drawer = document.getElementById('drawer-menu');
        const overlay = document.getElementById('drawer-overlay');
        const isVisible = drawer.classList.toggle('open');
        overlay.style.display = isVisible ? 'block' : 'none';
        document.body.style.overflow = isVisible ? 'hidden' : 'auto';
    }

    // üîπ Section Visibility Manager - UNCHANGED
    window.showSection = (sectionId) => {
        // Close the drawer if open
        const drawer = document.getElementById('drawer-menu');
        if (drawer.classList.contains('open')) {
            toggleDrawer(); 
        }

        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.add('hidden');
        });

        // Show the requested section
        document.getElementById(sectionId + '-view').classList.remove('hidden');

        // Update active state in drawer (optional, for visual feedback)
        document.querySelectorAll('.drawer-nav .nav-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`.drawer-nav a[data-section-id="${sectionId}"]`)?.classList.add('active');

        // Load specific data for certain sections
        if (sectionId === 'history') {
            loadSellHistory();
        }
        if (sectionId === 'cart') {
             loadCartItems();
        }
        if (sectionId === 'order') {
             loadOrdersHistory();
        }
        // When showing the home section, re-run filtering/sorting
        if (sectionId === 'home') {
             filterVehicles();
        }
    };

    // Set initial view
    document.addEventListener('DOMContentLoaded', () => {
        showSection('home');
        hideLoader(); // Ensure loader is hidden on load
    });

  </script>

  <style>
    :root {
      --primary-color: #00796B; 
      --primary-hover: #00695C;
      --background-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --danger-color: #dc3545;
      --success-bg: #4caf50;
      --error-bg: #f44336;
      --warning-bg: #ff9800;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-color);
      margin: 0;
      padding-top: 60px; /* Space for fixed header */
      color: var(--text-color);
    }

    /* --- LOADER BAR (NEW) --- */
    #loader-bar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: transparent;
        z-index: 10002;
        overflow: hidden;
    }
    #loader-bar::after {
        content: '';
        display: block;
        height: 100%;
        width: 30%; /* Start width */
        background-color: var(--danger-color); /* Highlight color */
        animation: progress-slide 1.5s infinite linear;
    }
    @keyframes progress-slide {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(400%); }
    }


    /* --- SECTION VISIBILITY --- */
    .content-section.hidden {
        display: none !important;
    }

    /* --- HEADER & DRAWER (UNCHANGED) --- */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      background: var(--primary-color);
      color: white;
      padding: 5px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 60px;
    }
    .header-left {
        display: flex;
        align-items: center;
    }
    header h1 { margin: 0; font-size: 20px; font-weight: 700; margin-left: 10px; }

    #drawer-toggle {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0 10px;
        line-height: 1;
    }

    /* Header Right (Cart) */
    .header-right {
        display: flex;
        align-items: center;
    }
    .cart-icon {
        position: relative;
        cursor: pointer;
        font-size: 24px;
        line-height: 1;
        padding: 0 10px;
    }
    .cart-badge {
        position: absolute;
        top: -8px;
        right: 0px;
        background: var(--danger-color);
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
        font-weight: 700;
        min-width: 20px;
        text-align: center;
        line-height: 1;
    }

    /* Search Bar (MODIFIED to include sort) */
    .search-filter {
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 20px 0;
}
.search-filter input, .search-filter select {
  flex: 1 1 250px;
  min-width: 150px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 15px;
}
      display: grid;
      grid-template-columns: 2fr 1fr 1fr; /* Search, Filter, Sort */
      gap: 15px;
      padding: 20px 0; /* Padding relative to main */
    }
    .search-filter input, .search-filter select {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        font-size: 15px;
        width: 100%;
    }

    /* Drawer Menu Styles (mostly unchanged) */
    #drawer-menu {
      position: fixed;
      top: 0;
      left: -300px; 
      width: 280px;
      height: 100%;
      background: var(--card-bg);
      z-index: 10001;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      transition: left 0.3s ease;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    #drawer-menu.open {
      left: 0;
    }
    #drawer-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: none;
    }
    .drawer-header {
        display: flex;
        justify-content: flex-end;
        padding-bottom: 10px;
        margin-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }
    .drawer-header button {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 24px;
        cursor: pointer;
        padding: 0;
    }
    .drawer-profile {
        text-align: center;
        margin-bottom: 30px;
    }
    .drawer-profile img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 10px;
        object-fit: cover;
        border: 2px solid var(--primary-color);
    }
    .drawer-profile h3 {
        margin: 0;
        font-size: 16px;
    }
    .drawer-profile p {
        margin: 0;
        font-size: 13px;
        color: var(--text-light);
    }
    .drawer-nav {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .drawer-nav .nav-item {
        padding: 12px 15px;
        text-decoration: none;
        color: var(--text-color);
        font-size: 16px;
        display: flex;
        align-items: center;
        transition: background 0.2s;
        border-radius: 6px;
    }
    .drawer-nav .nav-item:hover, .drawer-nav .nav-item.active {
        background: var(--border-color);
    }
    .drawer-nav .nav-item .icon {
        margin-right: 15px;
        font-size: 18px;
    }
    .drawer-logout-btn {
        background: var(--danger-color);
        color: white;
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .drawer-logout-btn:hover {
        background: #c82333;
    }

    main {
      padding: 0 20px;
    }

    /* Profile Section Styling (MODIFIED for detailed display) */
    .profile-card {
      display: flex;
      align-items: center;
      background: var(--card-bg);
      margin-top: 20px;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border-left: 4px solid var(--primary-color);
      flex-direction: column; 
      align-items: flex-start;
    }
    .profile-summary {
        display: flex;
        align-items: center;
        width: 100%;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    .profile-summary img { 
      width: 80px; 
      height: 80px;
      border-radius: 50%; 
      margin-right: 20px; 
      object-fit: cover;
      border: 3px solid var(--primary-color);
    }
    .profile-details h3 { margin: 0 0 5px 0; font-size: 18px; font-weight: 600; }
    .profile-details p { color: var(--text-light); margin: 0; font-size: 14px; margin-bottom: 5px;}
    .profile-details p span { font-weight: 500; color: var(--text-color); }

    /* Profile Edit Form Styles (NEW) */
    .profile-edit-form {
        width: 100%;
    }
    .profile-edit-form input {
        width: 100%;
        margin-bottom: 15px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        font-family: inherit;
        font-size: 16px;
    }
    .profile-edit-form label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--primary-color);
    }
    .profile-edit-form button {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: background 0.3s;
        width: 100%;
        margin-top: 10px;
    }
    .profile-edit-form button:hover {
        background: var(--primary-hover);
    }


    /* Vehicle Grid (UNCHANGED) */
    .section-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-color);
      margin-top: 30px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 5px;
    }
    .vehicle-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    /* Card Styling (UNCHANGED) */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .card-image { 
      width: 100%; 
      height: 200px; 
      background-size: cover; 
      background-position: center;
      border-bottom: 1px solid var(--border-color);
    }
    .card-content { padding: 18px; }
    .card-content h3 { 
      margin: 0 0 8px 0; 
      color: var(--text-color); 
      font-size: 18px; 
      font-weight: 600;
    }
    .card-content .specs { 
      color: var(--text-light); 
      margin: 5px 0 10px 0; 
      font-size: 14px; 
    }
    .card-content .specs span { font-weight: 500; color: var(--text-color); }
    .card-content .description { 
        font-size: 14px; 
        color: var(--text-color); 
        margin-bottom: 15px; 
        min-height: 40px; 
        overflow: hidden; 
    }

    /* Card Actions (Buy/Cart) (UNCHANGED) */
    .card-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
    }
    .price { 
      font-size: 22px; 
      color: var(--primary-color); 
      font-weight: 700; 
      margin: 0;
    }
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    .buy-btn, .cart-btn {
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        width: auto !important; 
        margin-top: 0;
    }
    .buy-btn {
        background: var(--primary-color);
        color: white;
        border: none;
    }
    .cart-btn {
        background: #f0f0f0;
        color: var(--text-color);
        border: 1px solid #ddd;
    }

    /* Sell Vehicle Form Styling (UPDATED to include previews) */
    .sell-form-container {
      background: var(--card-bg);
      margin-top: 20px;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .sell-form-container h2 { 
      font-size: 22px; 
      font-weight: 600; 
      color: var(--primary-color);
      margin-top: 0;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    .sell-form-container input, .sell-form-container select, .sell-form-container textarea {
      width: 100%;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-family: inherit;
      font-size: 16px;
    }
    .sell-form-container textarea {
        resize: vertical;
    }
    .sell-form-container .input-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .sell-form-container .full-width {
        grid-column: 1 / -1;
    }
    .sell-form-container button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background 0.3s;
    }
    .sell-form-container button:hover { background: var(--primary-hover); }
    .sell-form-container .note {
        font-size: 12px;
        color: var(--text-light);
        margin-top: -10px;
        margin-bottom: 15px;
        display: block;
    }

    /* Preview styles */
    .preview-grid {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .preview-wrapper {
      position: relative;
      width: 120px;
      height: 90px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      background: #fafafa;
    }
    .preview-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .preview-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .preview-kind {
      position: absolute;
      left: 6px;
      bottom: 6px;
      background: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-light);
      font-weight: 700;
      text-transform: uppercase;
    }

    /* --- SELL HISTORY / ORDERS TABLE STYLING --- */
    .history-table, .orders-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: var(--card-bg);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .history-table th, .history-table td, .orders-table th, .orders-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
    }
    .history-table th, .orders-table th {
        background: #e9ecef;
        font-weight: 600;
        color: var(--text-color);
    }
    .history-table tr:last-child td, .orders-table tr:last-child td {
        border-bottom: none;
    }
    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-badge.pending {
        background-color: #ff980033;
        color: var(--warning-bg);
    }
    .status-badge.approved {
        background-color: #4caf5033;
        color: var(--success-bg);
    }
    .status-badge.rejected {
        background-color: #f4433633;
        color: var(--error-bg);
    }
    .history-table .action-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        background: var(--primary-color);
        color: white;
    }

    /* --- NEW CART STYLES --- */
    .cart-container {
        display: flex;
        gap: 25px;
        margin-top: 20px;
        align-items: flex-start; 
    }
    .cart-items-list {
        flex: 3; 
        min-height: 200px;
    }
    .cart-summary-card {
        flex: 1; 
        background: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid var(--border-color);
        position: sticky; 
        top: 80px;
    }
    .cart-summary-card h3 {
        font-size: 18px;
        margin-top: 0;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }
    .total-price-text {
        font-size: 18px;
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
    }
    .total-price-text span {
        color: var(--primary-color);
        font-size: 20px;
        font-weight: 700;
    }
    .checkout-btn {
        width: 100%;
        padding: 12px;
        font-size: 16px;
    }
    .checkout-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .empty-state {
        text-align: center;
        padding: 50px 20px;
        background: var(--card-bg);
        border-radius: 10px;
        border: 2px dashed var(--border-color);
        color: var(--text-light);
        font-size: 18px;
    }

    /* Cart Item Card */
    .cart-item-card {
        display: flex;
        align-items: center;
        background: var(--card-bg);
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-left: 5px solid var(--primary-color);
        transition: box-shadow 0.2s;
    }
    .cart-item-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .item-image {
        width: 80px;
        height: 60px;
        background-size: cover;
        background-position: center;
        border-radius: 6px;
        margin-right: 15px;
        flex-shrink: 0;
    }
    .item-details {
        flex-grow: 1;
    }
    .item-details h3 {
        font-size: 16px;
        margin: 0 0 5px 0;
        font-weight: 600;
    }
    .item-specs {
        font-size: 13px;
        color: var(--text-light);
        margin: 0;
    }
    .item-price {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0 30px;
        flex-shrink: 0;
    }
    .remove-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s;
    }
    .remove-btn:hover {
        background: #c82333;
    }

    footer {
      text-align: center;
      padding: 20px;
      background: #343a40;
      color: #adb5bd;
      margin-top: 40px;
      font-size: 14px;
    }

    /* --- TOAST STYLES (UNCHANGED) --- */
    #toast-container {
      position: fixed;
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%); 
      z-index: 10003; /* Higher z-index than loader */
      display: flex;
      flex-direction: column-reverse; 
      align-items: center;
      max-width: 90%;
    }
    .toast {
      min-width: 250px;
      max-width: 350px;
      background-color: var(--text-color);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      opacity: 1;
      transform: translateY(0); 
      transition: opacity 0.3s ease, transform 0.3s ease;
      font-size: 15px;
      text-align: center;
    }
    .toast.fade-out {
      opacity: 0;
      transform: translateY(-20px); 
    }
    .toast.success { background-color: var(--success-bg); }
    .toast.error { background-color: var(--error-bg); }
    .toast.warning { background-color: var(--warning-bg); }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      main {
          padding: 0 10px;
      }
      .profile-card, .sell-form-container {
        margin: 15px 0;
        padding: 20px;
      }
      .search-filter {
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  padding: 20px 0;
}
.search-filter input, .search-filter select {
  flex: 1 1 250px;
  min-width: 150px;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 15px;
}
        grid-template-columns: 1fr; /* Stack columns on mobile */
        padding: 10px 0;
      }
      .search-filter input, .search-filter select {
        grid-column: 1 / -1; /* Make all elements full width */
      }
      .sell-form-container .input-group {
        grid-template-columns: 1fr;
      }
      /* Responsive Cart */
      .cart-container {
            flex-direction: column;
        }
        .cart-summary-card {
            order: -1; /* Move summary to top on mobile */
            width: 100%;
            position: relative;
            top: 0;
            margin-bottom: 20px;
        }
        .cart-item-card {
            flex-wrap: wrap;
            border-left: none;
            border: 1px solid var(--border-color);
        }
        .item-image {
            margin-bottom: 10px;
        }
        .item-details, .item-price {
            flex-basis: 100%;
            margin: 0;
        }
        .item-price {
            order: 4; 
            margin-top: 10px;
            font-size: 20px;
        }
        .item-actions {
            flex-basis: 100%;
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        /* Responsive Tables (Sell History and Orders) */
        .history-table th, .history-table td, .orders-table th, .orders-table td {
            display: block;
            width: 100% !important;
            box-sizing: border-box;
            text-align: right;
            padding: 8px 10px;
        }
        .history-table thead, .orders-table thead {
            display: none; 
        }
        .history-table tr, .orders-table tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: var(--card-bg);
            padding: 10px;
        }
        .history-table td, .orders-table td {
            border-bottom: 1px dashed var(--border-color);
            position: relative;
        }
        .history-table td:last-child, .orders-table td:last-child {
             border-bottom: none;
        }
        .history-table td::before, .orders-table td::before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            font-weight: 600;
            color: var(--primary-color);
            text-align: left;
        }
    }
  </style>
</head>
<body>
  <div id="loader-bar"></div> <div id="toast-container"></div>

  <div id="drawer-menu">
    <div class="drawer-header">
        <button onclick="toggleDrawer()">‚úï</button>
    </div>
    <div class="drawer-profile">
        <img id="userPhotoDrawer" alt="User Photo" />
        <h3 id="userNameDrawer"></h3>
        <p id="userEmailDrawer"></p>
    </div>
    <nav class="drawer-nav">
        <a href="#" class="nav-item" data-section-id="home" onclick="showSection('home')">Home</a>
        <a href="#" class="nav-item" data-section-id="cart" onclick="showSection('cart')">Cart</a> 
        <a href="#" class="nav-item" data-section-id="order" onclick="showSection('order')">Orders</a> 
        <a href="#" class="nav-item" data-section-id="sell" onclick="showSection('sell')">Sell Your Own Vehicle</a>
        <a href="#" class="nav-item" data-section-id="history" onclick="showSection('history')">Sell History</a> 
        <a href="#" class="nav-item" data-section-id="profile" onclick="showSection('profile')">Profile</a>
    </nav>
    <button class="drawer-logout-btn" onclick="logout()">Logout</button>
  </div>
  <div id="drawer-overlay" onclick="toggleDrawer()"></div>

  <header>
    <div class="header-left">
        <button id="drawer-toggle" onclick="toggleDrawer()">‚ò∞</button>
        <h1>JD MotoHub</h1>
    </div>
    <div class="header-right">
        <div class="cart-icon" onclick="showSection('cart')"> üõí 
            <span id="cart-count" class="cart-badge">0</span>
        </div>
    </div>
  </header>

  <main>
    <div id="home-view" class="content-section">
      <h2 class="section-title">Available Vehicles</h2>

      <div class="search-filter">
        <input type="text" placeholder="Search by name, year, km, or price..." id="search"> 
        <select id="filter">
          <option value="all">All Vehicles</option>
          <option value="bike">Bikes</option>
          <option value="car">Cars</option>
        </select>
        <select id="sort">
          <option value="default">Default Sort</option>
          <option value="name_asc">Name (A-Z)</option>
          <option value="name_desc">Name (Z-A)</option>
          <option value="year_desc">Year (Newest)</option>
          <option value="year_asc">Year (Oldest)</option>
          <option value="km_asc">Kilometers (Low to High)</option>
          <option value="km_desc">Kilometers (High to Low)</option>
          <option value="price_asc">Price (Low to High)</option>
          <option value="price_desc">Price (High to Low)</option>
        </select>
        </div>

      <div class="vehicle-grid" id="vehicleGrid">
        </div>
    </div>

    <div id="cart-view" class="content-section hidden">
        <h2 class="section-title">Shopping Cart (<span id="cart-count-display">0</span> Items)</h2>

        <div class="cart-container">
            <div class="cart-items-list" id="cartItemsList">
                </div>

            <div class="cart-summary-card">
                <h3>Order Summary</h3>
                <div id="cartSummary" class="summary-details">
                    <p class="total-price-text">Total: <span>‚Çπ0</span></p>
                </div>
                <button id="checkoutButton" onclick="checkoutCart()" class="buy-btn checkout-btn" disabled>Proceed to Checkout</button>
            </div>
        </div>
    </div>

    <div id="order-view" class="content-section hidden">
        <h2 class="section-title">Your Orders History</h2>
        <table class="history-table orders-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Vehicle</th>
                    <th>Price</th>
                    <th>Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                </tbody>
        </table>
    </div>

    <div id="sell-view" class="content-section hidden">
      <div class="sell-form-container">
        <h2>Submit Your Vehicle for Sale</h2>

        <div class="input-group">
            <input type="text" placeholder="Your Name" id="sellername" required>
            <input type="email" placeholder="Your Email Id" id="selleremail" required readonly title="Email is pre-filled from your login">
            <input type="number" placeholder="Your Phone No" id="sellerphone" required>
            <input type="number" placeholder="Alternate Phone No (Optional)" id="selleraltphone">
        </div>
        <input type="text" placeholder="Your Address" id="selleraddress" class="full-width" required>

        <h3 class="section-title" style="font-size: 18px; margin-top: 30px; margin-bottom: 15px; border-bottom: none;">Vehicle Details</h3>
        <input type="text" placeholder="Vehicle Name (e.g., Honda City)" id="vname" required>
        <textarea id="vdescription" placeholder="Detailed Description (e.g., Engine condition, extras, accident history)" rows="4" class="full-width" required></textarea>

        <div class="input-group">
            <select id="vtype">
                <option value="bike">Bike</option>
                <option value="car">Car</option>
            </select>
            <input type="number" placeholder="Year (e.g., 2020)" id="vyear" required>
            <input type="number" placeholder="Kilometers Driven (e.g., 50000)" id="vkm" required>
            <input type="number" placeholder="Your Expected Price (‚Çπ)" id="vprice" required>
        </div>

        <label for="vimages" style="margin-top:10px; display:block; font-weight:700; color:var(--primary-color);">Image URLs (Comma-separated)</label>
        <input type="text" placeholder="https://image1.jpg, https://image2.jpg" id="vimages" class="full-width">
        <button type="button" onclick="addImageURLsToSelection()" style="margin-bottom:10px;">Add URLs to Selection</button>
        <span class="note">Or choose image files below (files will be converted to Base64 in-browser). Both URLs and files are stored together in the same vehicle record.</span>

        <label for="vfiles" style="margin-top:12px; display:block; font-weight:700; color:var(--primary-color);">Choose Image File(s)</label>
        <input type="file" id="vfiles" accept="image/*" multiple onchange="handleFileSelection(event)">

        <div class="preview-grid" id="imagePreviewContainer" aria-live="polite" style="margin-top:12px;"></div>

        <button onclick="addVehicle()" style="margin-top:18px;">Submit Vehicle for Approval</button>
      </div>
    </div>

    <div id="history-view" class="content-section hidden"> 
      <h2 class="section-title">Your Vehicle Sell History</h2>
      <table class="history-table">
        <thead>
          <tr>
            <th>Vehicle Name</th>
            <th>Type</th>
            <th>Your Quoted Price</th>
            <th>Final Selling Price</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="historyTableBody">
          </tbody>
      </table>
    </div>

    <div id="profile-view" class="content-section hidden">
        <h2 class="section-title">Your Profile</h2>
        <div class="profile-card">
            <div class="profile-summary">
                <img id="userPhotoProfile" alt="User Photo" />
                <div class="profile-details">
                    <h3 id="userNameProfile"></h3>
                    <p>Email: <span id="userEmailProfile"></span></p>
                    <p>Mobile No: <span id="userPhoneProfile"></span></p>
                    <p>Address: <span id="userAddressProfile"></span></p>
                </div>
            </div>

            <div class="profile-edit-form">
                <h3>Edit Profile Details</h3>

                <label for="profile-input-name">Full Name</label>
                <input type="text" id="profile-input-name" placeholder="Name" required>

                <label for="profile-input-phone">Mobile No. (Required for orders)</label>
                <input type="number" id="profile-input-phone" placeholder="Mobile Number" required>

                <label for="profile-input-address">Address</label>
                <input type="text" id="profile-input-address" placeholder="Address" required>

                <label for="profile-input-email">Email</label>
                <input type="email" id="profile-input-email" placeholder="Email" readonly title="Email cannot be changed here">

                <button onclick="updateUserProfile()">Update Profile</button>
            </div>
        </div>
    </div>

  </main>

  <footer>
    ¬© 2025 JD MotoHub
  </footer>

  <script>
    // üîç Filter and Sort Logic (kept here for global scope access)
    const search = document.getElementById("search");
    const filter = document.getElementById("filter");
    const sort = document.getElementById("sort"); // ‚≠ê New Sort Element
    const vehicleGridElement = document.getElementById("vehicleGrid");

    search.addEventListener("input", filterVehicles);
    filter.addEventListener("change", filterVehicles);
    sort.addEventListener("change", filterVehicles); // ‚≠ê New Listener

    function filterVehicles() {
      const query = search.value.toLowerCase();
      const type = filter.value;
      const sortBy = sort.value; // ‚≠ê Get sort value
      let cards = Array.from(vehicleGridElement.querySelectorAll(".card"));
      
      if (document.getElementById('home-view').classList.contains('hidden')) return;

      // 1. FILTERING
      cards.forEach(card => {
        const cardName = card.dataset.name.toLowerCase();
        const cardYear = card.dataset.year;
        const cardKm = card.dataset.km;
        const cardPrice = card.dataset.price;

        const searchableText = `${cardName} ${cardYear} ${cardKm} ${cardPrice}`;

        const matchesSearch = searchableText.includes(query);
        const matchesType = (type === "all" || card.dataset.type === type);

        // Temporarily hide non-matching elements (will be re-shown after sorting)
        card.style.display = (matchesSearch && matchesType) ? "grid" : "none";
      });

      // Filter only the *visible* cards for sorting
      let visibleCards = cards.filter(card => card.style.display !== 'none');

      // 2. SORTING
      visibleCards.sort((a, b) => {
        const aVal = a.dataset[sortBy.split('_')[0]];
        const bVal = b.dataset[sortBy.split('_')[0]];
        const direction = sortBy.split('_')[1];

        if (sortBy === 'default') return 0; // No sorting

        // Numeric fields (Year, KM, Price)
        if (sortBy.includes('year') || sortBy.includes('km') || sortBy.includes('price')) {
          const numA = parseFloat(aVal);
          const numB = parseFloat(bVal);
          if (direction === 'asc') return numA - numB;
          return numB - numA;
        }

        // String fields (Name)
        if (sortBy.includes('name')) {
          const nameA = aVal.toLowerCase();
          const nameB = bVal.toLowerCase();
          if (direction === 'asc') return nameA.localeCompare(nameB);
          return nameB.localeCompare(nameA);
        }

        return 0;
      });

      // 3. RE-RENDERING (to apply sort order)
      // Append the sorted cards back to the grid. The DOM function appendChild automatically moves existing elements.
      visibleCards.forEach(card => vehicleGridElement.appendChild(card));
    }
  </script>
</body>
</html>
