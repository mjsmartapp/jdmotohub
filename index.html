<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JD MotoHub</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
        getAuth, signOut, onAuthStateChanged, updateProfile, 
        GoogleAuthProvider, signInWithPopup // ‚≠ê NEW: Google Auth Imports
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js"; 
    import { getDatabase, ref, push, onValue, set, query, orderByChild, equalTo, get } 
      from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js"; 

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBuTQZ0zwLMLdfzzD2KjEhaGk6BTzJK72s",
      authDomain: "secondhand-803a3.firebaseapp.com",
      databaseURL: "https://secondhand-803a3-default-rtdb.firebaseio.com/",
      projectId: "secondhand-803a3",
      storageBucket: "secondhand-803a3.firebasestorage.app",
      messagingSenderId: "554970268999",
      appId: "1:554970268999:web:d4f418e31c65ef8599f862",
      measurementId: "G-8D44TJDZ24"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUserId = null; 
    let currentUserEmail = null; 
    let currentUserPhone = null; 
    let currentUserAddress = null; 
    let cartCount = 0; 

    // ‚≠ê NEW: Global variable to store pending action data before login
    let pendingAction = null; 

    // üîπ Utility Functions for Loader Bar
    const loader = document.getElementById('loader-bar');
    window.showLoader = () => { loader.style.display = 'block'; };
    window.hideLoader = () => { loader.style.display = 'none'; };

    // üîπ Toast Notification Function (Top Center)
    window.showToast = (message, type = 'success') => {
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        document.body.appendChild(toastContainer);
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerText = message;
      toastContainer.prepend(toast);

      setTimeout(() => {
        toast.classList.add('fade-out');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 3000); 
    };

    // ‚≠ê NEW: Google Sign-In Function
    window.googleLoginPopup = async (action, data = null) => {
        // Store the intended action to be resumed after login
        pendingAction = { action, data }; 
        showLoader();
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
            // onAuthStateChanged listener will detect successful login and handle pendingAction
        } catch (error) {
            if (error.code !== 'auth/popup-closed-by-user') {
                showToast(`Login failed: ${error.message}`, "error");
            }
        } finally {
            hideLoader();
        }
    };


    // üõí Load Cart Count from Firebase - MODIFIED to handle logged-out state
    function loadCartCount() {
        const cartCountElement = document.getElementById('cart-count');
        const cartCountDrawerElement = document.getElementById('cart-count-drawer');

        if (!currentUserId) {
            cartCountElement.innerText = 0; // Show 0 when logged out
            cartCountDrawerElement.innerText = 0;
            return;
        }

        // Listen for real-time changes to the user's cart node
        onValue(ref(db, `users/${currentUserId}/cart`), (snapshot) => {
            const cartItems = snapshot.val();
            cartCount = cartItems ? Object.keys(cartItems).length : 0;
            cartCountElement.innerText = cartCount;
            cartCountDrawerElement.innerText = cartCount;
        }, {
            onlyOnce: false // Keep listening for changes
        });
    }

    // üõí Add Vehicle to Cart in Firebase - MODIFIED for Login Check
    window.addToCart = async (vehicleKey, vehicleName, skipAuthCheck = false) => {
        if (!currentUserId && !skipAuthCheck) {
            // ‚≠ê MODIFIED: Initiate Google Login if not logged in
            showToast("Please log in with Google to add items to your cart.", "warning");
            return window.googleLoginPopup('cart', { key: vehicleKey, name: vehicleName });
        }

        try {
            // Set the item in the cart (using set to ensure the key is the vehicle ID)
            await set(ref(db, `users/${currentUserId}/cart/${vehicleKey}`), true);

            showToast(`${vehicleName} added to cart!`, "success");
            // loadCartCount handles the UI update via onValue listener
        } catch (err) {
            showToast(`Error adding to cart: ${err.message}`, "error");
        }
    };

    // üì¶ Simulate a Direct Purchase (Log as Order) - MODIFIED for Login Check
    window.buyVehicle = async (vehicleKey, vehicleName, price) => {
        const vehicleData = { key: vehicleKey, name: vehicleName, price: price };

        if (!currentUserId) {
            // ‚≠ê MODIFIED: Initiate Google Login on Buy Now if not logged in
            showToast("Please log in with Google to purchase this vehicle.", "warning");
            return window.googleLoginPopup('buy', vehicleData);
        }

        // ‚≠ê NEW: Check for required Mobile Number - Keep this check
        if (!currentUserPhone || currentUserPhone.length < 10) {
            showToast("Mobile Number is required to place an order. Please update your profile.", "error");
            showSection('profile'); // Redirect to profile view
            return;
        }

        // ** Open the professional Buy Now Modal **
        window.openBuyNowModal(vehicleData);
    };

    // üí∞ Actual Order Placement (Moved from old buyVehicle)
    window.placeOrderFromModal = async (vehicleKey, vehicleName, price, paymentMethod, downPayment, loanTenure, interestRate, loanAmount) => {
        
        // Re-check phone number just in case
        if (!currentUserPhone || currentUserPhone.length < 10) {
            showToast("Mobile Number is required to place an order. Please update your profile.", "error");
            showSection('profile');
            closeBuyNowModal(); 
            return;
        }

        showLoader(); // Show loader during purchase

        try {
            const orderRef = push(ref(db, `users/${currentUserId}/orders`));
            await set(orderRef, {
                vehicleKey: vehicleKey,
                vehicleName: vehicleName,
                price: price,
                timestamp: new Date().toISOString(),
                status: "processing",
                paymentMethod: paymentMethod, 
                loanInfo: {
                    downPayment: paymentMethod === 'emi' ? (parseInt(downPayment) || 0) : 0, 
                    loanTenure: paymentMethod === 'emi' ? (parseInt(loanTenure) || 0) : 0,
                    interestRate: paymentMethod === 'emi' ? (parseFloat(interestRate) || 0) : 0,
                    loanAmount: paymentMethod === 'emi' ? (parseInt(loanAmount) || 0) : 0 
                },
                buyerInfo: { 
                    name: auth.currentUser.displayName,
                    email: currentUserEmail,
                    phone: currentUserPhone,
                    address: currentUserAddress || 'Not Provided'
                }
            });
            showToast(`Order placed for ${vehicleName} (‚Çπ${parseInt(price).toLocaleString('en-IN')})!`, "success");
            closeBuyNowModal(); 
            showSection('order'); 
        } catch (err) {
            showToast(`Error placing order: ${err.message}`, "error");
        } finally {
            hideLoader(); 
        }
    }


    // üè¶ NEW: EMI/Loan Calculator Logic (Simplified Example)
    window.calculateEMI = (principal, rate, years) => {
        if (principal <= 0 || rate <= 0 || years <= 0) return 0;

        const monthlyRate = (rate / 100) / 12; // Annual rate to monthly rate
        const numberOfPayments = years * 12;
        
        // EMI formula: P * r * (1 + r)^n / ((1 + r)^n - 1)
        const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments) / 
                    (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
                    
        return emi;
    }

    // 
    // ‚≠ê NEW MODAL FUNCTIONS 
    //
    window.openBuyNowModal = (vehicleData) => {
        const modal = document.getElementById('buyNowModal');
        const overlay = document.getElementById('buyNowOverlay');
        
        const price = parseInt(vehicleData.price);
        const formattedPrice = price.toLocaleString('en-IN');
        
        // 1. Update Modal Content
        document.getElementById('modalVehicleName').innerText = vehicleData.name;
        document.getElementById('modalVehiclePrice').innerText = `‚Çπ${formattedPrice}`;
        
        const paymentOptionSelect = document.getElementById('modalPaymentOption');
        if (paymentOptionSelect) {
            paymentOptionSelect.value = 'emi'; // Default to EMI
        }

        document.getElementById('modalDownPayment').value = Math.min(price * 0.20, 50000).toFixed(0); 
        document.getElementById('modalLoanAmountDisplay').innerText = `‚Çπ${price.toLocaleString('en-IN')}`; // Initial loan amount

        // Store keys for final action
        modal.dataset.vehicleKey = vehicleData.key;
        modal.dataset.vehicleName = vehicleData.name;
        modal.dataset.vehiclePrice = vehicleData.price;

        // 2. Calculate initial EMI and adjust view based on default 'emi'
        window.updateEMICalculation(); 

        // 3. Show Modal
        modal.classList.add('open');
        overlay.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent scrolling background
    }

    window.closeBuyNowModal = () => {
        document.getElementById('buyNowModal').classList.remove('open');
        document.getElementById('buyNowOverlay').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    window.updateEMICalculation = () => {
        const modal = document.getElementById('buyNowModal');
        if (!modal || !modal.dataset.vehiclePrice) return { loanAmount: 0, emi: 0 }; 

        const price = parseInt(modal.dataset.vehiclePrice);

        const paymentOption = document.getElementById('modalPaymentOption').value;
        const emiSection = document.getElementById('emiArrangementSection');
        
        let effectiveDownPayment = 0;
        let loanAmount = 0;
        let emi = 0;
        let loanTenure = 0;
        let interestRate = 0;

        if (paymentOption === 'full_paid') {
            emiSection.style.display = 'none';
            document.getElementById('modalLoanAmountDisplay').innerText = `‚Çπ0`;
            document.getElementById('modalMonthlyEMI').innerText = 'N/A';
            document.getElementById('modalConfirmOrder').innerText = 'Confirm Full Payment Order';
            
            return { loanAmount: 0, emi: 0 };

        } else { // paymentOption === 'emi'
            emiSection.style.display = 'block';

            const downPaymentInput = document.getElementById('modalDownPayment');
            const downPayment = parseInt(downPaymentInput.value) || 0;
            
            effectiveDownPayment = Math.min(downPayment, price);
            downPaymentInput.value = effectiveDownPayment.toFixed(0); 

            loanTenure = parseInt(document.getElementById('modalLoanTenure').value) || 12;
            interestRate = parseFloat(document.getElementById('modalInterestRate').value) || 10;
            
            loanAmount = Math.max(0, price - effectiveDownPayment);
            emi = calculateEMI(loanAmount, interestRate, loanTenure / 12); 
            
            document.getElementById('modalLoanAmountDisplay').innerText = `‚Çπ${loanAmount.toLocaleString('en-IN')}`;
            document.getElementById('modalMonthlyEMI').innerText = emi > 0 ? `‚Çπ${Math.round(emi).toLocaleString('en-IN')}` : '‚Çπ0';
            
            document.getElementById('modalConfirmOrder').innerText = loanAmount > 0 ? 'Arrange Loan & Order' : 'Confirm Cash Order';
            
            return { 
                loanAmount, 
                emi, 
                downPayment: effectiveDownPayment, 
                loanTenure, 
                interestRate 
            };
        }
    }

    window.confirmBuyNow = () => {
        const modal = document.getElementById('buyNowModal');
        const key = modal.dataset.vehicleKey;
        const name = modal.dataset.vehicleName;
        const price = modal.dataset.vehiclePrice;
        
        const paymentMethod = document.getElementById('modalPaymentOption').value;

        if (paymentMethod === 'full_paid') {
            showToast("Confirming order for full payment (Cash/Transfer).", "warning");
            window.placeOrderFromModal(key, name, price, paymentMethod, 0, 0, 0, 0);
            return;
        }

        // EMI/Loan path
        const { loanAmount } = window.updateEMICalculation(); 
        
        const downPayment = document.getElementById('modalDownPayment').value;
        const loanTenure = document.getElementById('modalLoanTenure').value;
        const interestRate = document.getElementById('modalInterestRate').value;

        if (loanAmount > 0) {
             showToast("Loan arrangement request sent. Proceeding to place the provisional order.", "warning");
        }
        
        window.placeOrderFromModal(key, name, price, paymentMethod, downPayment, loanTenure, interestRate, loanAmount);
    }

    // üí∞ NEW: Simulate Checkout - MODIFIED for Login Check
    window.checkoutCart = async (skipAuthCheck = false) => {
        if (!currentUserId && !skipAuthCheck) {
            // ‚≠ê MODIFIED: Initiate Google Login if not logged in
            showToast("Please log in with Google to proceed to checkout.", "warning");
            return window.googleLoginPopup('checkout');
        }

        if (!currentUserPhone || currentUserPhone.length < 10) {
            showToast("Mobile Number is required for checkout. Please update your profile.", "error");
            showSection('profile'); // Redirect to profile view
            return;
        }

        showLoader(); 

        try {
            // Here, we simulate by logging the event and clearing the cart.
            await set(ref(db, `users/${currentUserId}/cart`), null);
            showToast("Checkout Successful! Your order has been placed and is being processed.", "success");
            showSection('order'); 
        } catch (err) {
            showToast(`Error during checkout: ${err.message}`, "error");
        } finally {
            hideLoader();
        }
    }

    // üõí NEW: Load Cart Items
    window.loadCartItems = () => {
        const cartList = document.getElementById("cartItemsList");
        const cartSummary = document.getElementById("cartSummary");
        cartList.innerHTML = ''; 
        let totalCartPrice = 0;
        let itemsInCart = 0;

        if (!currentUserId) {
            document.getElementById('cart-count-display').innerText = 0;
            cartList.innerHTML = '<p class="empty-state">Please log in to view your shopping cart. <button onclick="googleLoginPopup(\'cart\')">Login with Google</button></p>';
            cartSummary.innerHTML = '<p class="total-price-text">Total: <span>‚Çπ0</span></p>';
            document.getElementById('checkoutButton').disabled = true;
            return;
        }
        // ... rest of loadCartItems logic remains the same ...
        const cartRef = ref(db, `users/${currentUserId}/cart`);
        onValue(cartRef, async (snapshot) => {
            const cartKeys = snapshot.val();
            itemsInCart = cartKeys ? Object.keys(cartKeys).length : 0;
            document.getElementById('cart-count-display').innerText = itemsInCart;
            cartList.innerHTML = '';
            totalCartPrice = 0;

            if (itemsInCart === 0) {
                cartList.innerHTML = '<p class="empty-state">Your cart is empty. Start shopping!</p>';
                cartSummary.innerHTML = '<p class="total-price-text">Total: <span>‚Çπ0</span></p>';
                document.getElementById('checkoutButton').disabled = true;
                return;
            }

            document.getElementById('checkoutButton').disabled = false;

            const vehiclePromises = Object.keys(cartKeys).map(key => new Promise((resolve, reject) => {
                onValue(ref(db, `vehicles/${key}`), (vehicleSnapshot) => {
                    const v = vehicleSnapshot.val();
                    if (v && v.status === 'approved') {
                        v.key = vehicleSnapshot.key;
                        resolve(v);
                    } else {
                        resolve(null); 
                    }
                }, { onlyOnce: true });
            }));

            const vehicles = (await Promise.all(vehiclePromises)).filter(v => v !== null);

            vehicles.forEach(v => {
                const displayPrice = v.adminPrice || v.price || 0;
                const formattedPrice = parseInt(displayPrice).toLocaleString('en-IN');
                totalCartPrice += parseInt(displayPrice);

                const cartItem = document.createElement("div");
                cartItem.className = "cart-item-card";
                cartItem.innerHTML = `
                    <div class="item-image" style="background-image: url('${v.img}');"></div>
                    <div class="item-details">
                        <h3>${v.name}</h3>
                        <p class="item-specs">Year: ${v.year} | ${v.km} km</p>
                    </div>
                    <p class="item-price">‚Çπ${formattedPrice}</p>
                    <div class="item-actions">
                        <button class="remove-btn" onclick="removeFromCart('${v.key}', '${v.name}')">Remove</button>
                    </div>
                `;
                cartList.appendChild(cartItem);
            });

            cartSummary.innerHTML = `<p class="total-price-text">Subtotal: <span>‚Çπ${totalCartPrice.toLocaleString('en-IN')}</span></p>
                                     <p class="total-price-text">Tax: <span>‚Çπ0</span></p>
                                     <div style="border-top: 1px solid var(--border-color); margin-top: 10px; padding-top: 10px;">
                                        <p class="total-price-text">Total: <span style="font-size: 26px;">‚Çπ${totalCartPrice.toLocaleString('en-IN')}</span></p>
                                     </div>`;

        }, { onlyOnce: false }); 
    };

    // üõí NEW: Remove item from cart
    window.removeFromCart = async (vehicleKey, vehicleName) => {
        if (!currentUserId) return;
        try {
            await set(ref(db, `users/${currentUserId}/cart/${vehicleKey}`), null);
            showToast(`${vehicleName} removed from cart.`, "success");
        } catch (err) {
            showToast(`Error removing item: ${err.message}`, "error");
        }
    };


    // üì¶ NEW: Load Orders History
    window.loadOrdersHistory = () => {
        const ordersTableBody = document.getElementById("ordersTableBody");
        ordersTableBody.innerHTML = '<tr><td colspan="5">Loading your orders...</td></tr>';

        if (!currentUserId) {
            ordersTableBody.innerHTML = '<tr><td colspan="5">Please log in to view your order history.</td></tr>';
            return;
        }
        // ... rest of loadOrdersHistory logic remains the same ...
        onValue(ref(db, `users/${currentUserId}/orders`), (snapshot) => {
            ordersTableBody.innerHTML = "";
            let recordsFound = 0;
            const orders = [];

            snapshot.forEach((child) => {
                const order = child.val();
                order.orderId = child.key;
                orders.push(order);
            });

            orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            orders.forEach((order) => {
                recordsFound++;
                const formattedPrice = parseInt(order.price || 0).toLocaleString('en-IN');
                const orderDate = new Date(order.timestamp).toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                let statusClass = '';
                let statusText = order.status;

                if (order.status === 'processing') {
                    statusClass = 'pending'; 
                } else if (order.status === 'shipped') {
                    statusClass = 'approved'; 
                } else if (order.status === 'delivered') {
                    statusClass = 'approved'; 
                    statusText = 'Delivered';
                } else if (order.status === 'cancelled') {
                    statusClass = 'rejected';
                }
                
                const loanDetails = order.loanInfo && order.loanInfo.loanAmount > 0 
                    ? `<br><small>Loan: ‚Çπ${order.loanInfo.loanAmount.toLocaleString('en-IN')} | DP: ‚Çπ${order.loanInfo.downPayment.toLocaleString('en-IN')}</small>`
                    : '';
                
                const paymentDisplay = order.paymentMethod === 'full_paid' ? 'Full Paid' : 'EMI';

                const row = `
                    <tr>
                        <td data-label="Order ID">#${order.orderId.substring(0, 8).toUpperCase()}</td>
                        <td data-label="Vehicle">${order.vehicleName}</td>
                        <td data-label="Price">‚Çπ${formattedPrice}${loanDetails}<br><small>Method: ${paymentDisplay}</small></td>
                        <td data-label="Date">${orderDate}</td>
                        <td data-label="Status"><span class="status-badge ${statusClass}">${statusText.charAt(0).toUpperCase() + statusText.slice(1)}</span></td>
                    </tr>
                `;
                ordersTableBody.insertAdjacentHTML("beforeend", row);
            });

            if (recordsFound === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="5">You have no orders yet. Click "Buy Now" on a vehicle to place an order.</td></tr>';
            }
        }, (error) => {
            console.error("Error loading order history:", error);
            ordersTableBody.innerHTML = '<tr><td colspan="5">Error loading order history.</td></tr>';
        });
    };

    // ‚≠ê NEW: Function to load and set user profile data from DB
    async function loadUserProfile(user) {
        // ... existing loadUserProfile logic remains the same ...
        try {
            const profileSnapshot = await get(ref(db, `users/${user.uid}/profile`));
            const profileData = profileSnapshot.val();

            // Set global user variables
            currentUserPhone = profileData?.phone || null;
            currentUserAddress = profileData?.address || null;

            // Set Profile View fields
            document.getElementById("profile-input-name").value = user.displayName || "";
            document.getElementById("profile-input-phone").value = currentUserPhone || "";
            document.getElementById("profile-input-address").value = currentUserAddress || "";
            document.getElementById("profile-input-email").value = user.email || ""; // Readonly email

            // Set display fields
            document.getElementById("userNameProfile").innerText = user.displayName || "User";
            document.getElementById("userEmailProfile").innerText = user.email;
            document.getElementById("userPhoneProfile").innerText = currentUserPhone || "N/A (Required for Orders)";
            document.getElementById("userAddressProfile").innerText = currentUserAddress || "N/A";

        } catch (error) {
            console.error("Error loading user profile:", error);
        }
    }

    // ‚≠ê NEW: Function to update user profile data in Auth and DB
    window.updateUserProfile = async () => {
        if (!currentUserId) {
             return showToast("Please log in to update your profile.", "warning");
        }

        const newName = document.getElementById("profile-input-name").value.trim();
        const newPhone = document.getElementById("profile-input-phone").value.trim();
        const newAddress = document.getElementById("profile-input-address").value.trim();

        if (!newName || !newPhone || newPhone.length < 10) {
            return showToast("Name and a valid Mobile Number are required!", "warning");
        }

        showLoader();

        try {
            await updateProfile(auth.currentUser, {
                displayName: newName
            });

            const profileData = {
                name: newName,
                phone: newPhone,
                address: newAddress,
                lastUpdated: new Date().toISOString()
            };
            await set(ref(db, `users/${currentUserId}/profile`), profileData);

            await loadUserProfile(auth.currentUser); 

            document.getElementById("selleremail").value = auth.currentUser.email;
            document.getElementById("sellername").value = newName;
            document.getElementById("sellerphone").value = newPhone;


            showToast("Profile updated successfully!", "success");

        } catch (error) {
            showToast(`Error updating profile: ${error.message}`, "error");
        } finally {
            hideLoader();
        }
    };


    // üîí Protect Dashboard & Load User Info - MODIFIED TO ALLOW ACCESS WHEN LOGGED OUT
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        currentUserId = null; // Ensure ID is null
        currentUserEmail = null; 
        
        // ‚≠ê REMOVED REDIRECTION: Do NOT redirect to index.html

        // Update UI for logged-out state
        document.getElementById("userNameDrawer").innerText = "Guest User";
        document.getElementById("userEmailDrawer").innerText = "Please log in";
        document.getElementById("userPhotoDrawer").src = "https://static-00.iconduck.com/assets.00/user-avatar-icon-512x512-nghi2896.png";

      } else {
        currentUserId = user.uid; // Store UID
        currentUserEmail = user.email; 

        // Load user data
        await loadUserProfile(user); 
        loadCartCount();

        // Drawer Profile content
        document.getElementById("userPhotoDrawer").src = user.photoURL || "https://static-00.iconduck.com/assets.00/user-avatar-icon-512x512-nghi2896.png";
        document.getElementById("userNameDrawer").innerText = user.displayName || "User";
        document.getElementById("userEmailDrawer").innerText = user.email;

        // Pre-fill seller details on the Sell page
        document.getElementById("selleremail").value = user.email;
        document.getElementById("sellername").value = user.displayName || "";
        document.getElementById("sellerphone").value = currentUserPhone || "";
      }

      // ‚≠ê NEW: Handle Pending Action after successful login
      if (user && pendingAction) {
          showToast(`Welcome back, ${user.displayName}! Resuming your action...`, "success");
          const action = pendingAction.action;
          const data = pendingAction.data;

          // Clear pending action immediately
          pendingAction = null; 

          if (action === 'buy') {
              // Re-run buyVehicle logic which will now find a user (skips the phone check for a moment)
              window.openBuyNowModal(data); 

          } else if (action === 'cart') {
              // Re-run addToCart logic, skipping the auth check since we are authenticated now
              window.addToCart(data.key, data.name, true); 

          } else if (action === 'checkout') {
              // Re-run checkout logic, skipping the auth check
              window.checkoutCart(true); 
          }
      }
      
      // Load cart count after state is set (important for initial load)
      loadCartCount();
    });

    // üîπ Logout Function
    window.logout = () => {
      signOut(auth).then(() => {
        showToast("Logged out successfully.", "success");
        // After logout, onAuthStateChanged handles the state change and UI update
        window.showSection('home'); // Go back to home view
      });
    };

    //
    // --- NEW IMAGE PICKER + PREVIEW LOGIC ---
    //
    const selectedImages = [];
    let imageIdCounter = 0;

    window.handleFileSelection = (event) => {
      const files = Array.from(event.target.files || []);
      if (files.length === 0) return;
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          selectedImages.push({ id: `img_${imageIdCounter++}`, src: e.target.result, kind: 'file' });
          renderImagePreviews();
        };
        reader.readAsDataURL(file);
      });
      event.target.value = "";
    };

    window.addImageURLsToSelection = () => {
      const urlInput = document.getElementById("vimages").value.trim();
      if (!urlInput) return;
      const urls = urlInput.split(",").map(u => u.trim()).filter(u => u !== "");
      urls.forEach(u => selectedImages.push({ id: `img_${imageIdCounter++}`, src: u, kind: 'url' }));
      document.getElementById("vimages").value = "";
      renderImagePreviews();
    };

    window.removeSelectedImage = (id) => {
      const idx = selectedImages.findIndex(i => i.id === id);
      if (idx !== -1) {
        selectedImages.splice(idx, 1);
        renderImagePreviews();
      }
    };

    function renderImagePreviews() {
      const container = document.getElementById("imagePreviewContainer");
      if (!container) return;
      container.innerHTML = "";
      selectedImages.forEach(img => {
        const wrapper = document.createElement("div");
        wrapper.className = "preview-wrapper";
        wrapper.innerHTML = `
          <img src="${img.src}" alt="preview" loading="lazy" />
          <button type="button" class="preview-remove" onclick="removeSelectedImage('${img.id}')">‚úï</button>
          <div class="preview-kind">${img.kind === 'file' ? 'file' : 'url'}</div>
        `;
        container.appendChild(wrapper);
      });
    }

    //
    // üîπ Add Vehicle (sent to pending approval)
    //
    window.addVehicle = () => {
      if (!currentUserId) {
        return showToast("Please log in to sell a vehicle.", "warning");
      }
      
      const sellerName = document.getElementById("sellername").value.trim();
      const sellerEmail = document.getElementById("selleremail").value.trim();
      const sellerPhone = document.getElementById("sellerphone").value.trim();
      const sellerAltPhone = document.getElementById("selleraltphone").value.trim();
      const sellerAddress = document.getElementById("selleraddress").value.trim();

      const name = document.getElementById("vname").value.trim();
      const description = document.getElementById("vdescription").value.trim(); 
      const type = document.getElementById("vtype").value;
      const year = document.getElementById("vyear").value.trim();
      const km = document.getElementById("vkm").value.trim();
      const price = document.getElementById("vprice").value.trim();

      addImageURLsToSelection();

      const combinedImageSrcs = selectedImages.map(i => i.src);
      const imagesInput = combinedImageSrcs.join(","); 
      const img = combinedImageSrcs[0] || "https://images.unsplash.com/photo-1596557802874-954848074902?fit=crop&w=600&h=300&q=80";

      if (!sellerName || !sellerEmail || !sellerPhone || !sellerAddress || !name || !description || !year || !km || !price) {
        showToast("Please fill all required fields (Seller and Vehicle details)!", "warning");
        return;
      }

      if (combinedImageSrcs.length === 0) {
        showToast("Please add at least one image URL or file before submitting.", "warning");
        return;
      }

      const vehicleData = {
        seller: {
            name: sellerName,
            email: sellerEmail,
            phone: sellerPhone,
            altPhone: sellerAltPhone,
            address: sellerAddress
        },
        name,
        description, 
        type,
        year,
        km,
        price,
        img, 
        vimages: imagesInput, 
        status: "pending",
        submittedBy: currentUserEmail 
      };

      showLoader();
      push(ref(db, "vehicles/"), vehicleData)
        .then(() => {
          showToast("Vehicle submitted for admin approval!", "success");
          document.querySelectorAll("#sell-view input, #sell-view textarea").forEach(i => i.value = "");
          document.getElementById("vtype").value = "bike";
          selectedImages.length = 0;
          renderImagePreviews();
          // Re-populate seller details from current user info
          if(auth.currentUser) {
              loadUserProfile(auth.currentUser); 
          }
          showSection('history'); 
        })
        .catch((err) => {
          showToast(`Error submitting vehicle: ${err.message}`, "error");
        })
        .finally(() => {
          hideLoader();
        });
    };

    // üîπ Load Approved Vehicles (Home View) - UNCHANGED
    const vehicleGrid = document.getElementById("vehicleGrid");
    onValue(ref(db, "vehicles/"), (snapshot) => {
      vehicleGrid.innerHTML = "";
      const vehicles = [];
      snapshot.forEach((child) => {
        const v = child.val();
        const vehicleKey = child.key; 
        if (v.status === "approved") {
          const displayPrice = v.adminPrice || v.price || 0; 
          
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.type = v.type;
          card.dataset.name = v.name;
          card.dataset.year = v.year;
          card.dataset.km = v.km;
          card.dataset.price = displayPrice; 
          
          card.innerHTML = `
            <div class="card-image" style="background-image: url('${v.img}');"></div>
            <div class="card-content">
              <h3>${v.name}</h3>
              <p class="specs">Year: <span>${v.year}</span> | ${v.km} <span>km</span></p>
              <p class="description">${(v.description || 'No description provided.').substring(0, 50)}...</p>
              <div class="card-actions">
                <p class="price">‚Çπ${parseInt(displayPrice).toLocaleString('en-IN')}</p>
                <div class="action-buttons">
                    <button class="cart-btn" onclick="addToCart('${vehicleKey}', '${v.name}')">
                        üõí Add
                    </button>
                    <button class="buy-btn" onclick="buyVehicle('${vehicleKey}', '${v.name}', '${displayPrice}')">
                        Buy Now
                    </button>
                </div>
              </div>
            </div>
          `;
          vehicles.push(card);
        }
      });
      vehicles.forEach(card => vehicleGrid.appendChild(card));

      filterVehicles(); 
    });

    // üîπ Load Sell History - UNCHANGED (Will display message if not logged in)
    window.loadSellHistory = async () => {
        const historyTableBody = document.getElementById("historyTableBody");
        historyTableBody.innerHTML = "<tr><td colspan='6'>Loading your history...</td></tr>";

        if (!currentUserEmail) {
            historyTableBody.innerHTML = '<tr><td colspan="6">Please log in to see your history.</td></tr>';
            return;
        }
        // ... rest of loadSellHistory logic remains the same ...
        try {
            const userHistoryQuery = query(ref(db, "vehicles/"), orderByChild("submittedBy"), equalTo(currentUserEmail));

            onValue(userHistoryQuery, (snapshot) => {
                historyTableBody.innerHTML = "";
                let recordsFound = 0;

                snapshot.forEach((child) => {
                    const v = child.val();
                    recordsFound++;

                    let statusClass = '';
                    let statusText = '';
                    let finalPrice = v.price ? parseInt(v.price).toLocaleString('en-IN') : 'N/A';

                    if (v.status === 'approved') {
                        statusClass = 'approved';
                        statusText = 'Approved';
                        finalPrice = v.adminPrice ? parseInt(v.adminPrice).toLocaleString('en-IN') : finalPrice;
                    } else if (v.status === 'pending') {
                        statusClass = 'pending';
                        statusText = 'Pending Admin Review';
                    } else if (v.status === 'rejected') {
                        statusClass = 'rejected';
                        statusText = 'Rejected by Admin';
                    } else {
                        statusClass = 'unknown';
                        statusText = 'Unknown Status';
                    }

                    const row = `
                        <tr>
                            <td data-label="Vehicle Name">${v.name}</td>
                            <td data-label="Type">${v.type}</td>
                            <td data-label="Your Price">‚Çπ${parseInt(v.price || 0).toLocaleString('en-IN')}</td>
                            <td data-label="Final Price">‚Çπ${finalPrice}</td>
                            <td data-label="Status"><span class="status-badge ${statusClass}">${statusText}</span></td>
                            <td data-label="Action"><button class="action-btn view-details-btn" onclick="showToast('Details for ${v.name} - Status: ${statusText}', 'success')">View Details</button></td>
                        </tr>
                    `;
                    historyTableBody.insertAdjacentHTML("beforeend", row);
                });

                if (recordsFound === 0) {
                    historyTableBody.innerHTML = "<tr><td colspan='6'>You have not submitted any vehicles yet.</td></tr>";
                }
            }, (error) => {
                console.error("Error loading sell history:", error);
                historyTableBody.innerHTML = "<tr><td colspan='6'>Error loading history.</td></tr>";
            });

        } catch (err) {
            console.error("Error during history query setup:", err);
            historyTableBody.innerHTML = "<tr><td colspan='6'>An error occurred.</td></tr>";
        }
    };


    // üîπ Drawer Toggle Function
    window.toggleDrawer = () => {
        const drawer = document.getElementById('drawer-menu');
        const overlay = document.getElementById('drawer-overlay');
        const isVisible = drawer.classList.toggle('open');
        overlay.style.display = isVisible ? 'block' : 'none';
        document.body.style.overflow = isVisible ? 'hidden' : 'auto';
    }

    // üîπ Section Visibility Manager - UNCHANGED
    window.showSection = (sectionId) => {
        const drawer = document.getElementById('drawer-menu');
        const overlay = document.getElementById('drawer-overlay');
        if (drawer.classList.contains('open')) {
            drawer.classList.remove('open');
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.add('hidden');
        });

        const targetSection = document.getElementById(sectionId + '-view');
        if (targetSection) {
            targetSection.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.querySelectorAll('.drawer-nav .nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.dataset.section === sectionId) {
                item.classList.add('active');
            }
        });
        
        if (sectionId === 'cart') {
            loadCartItems();
        } else if (sectionId === 'order') {
            loadOrdersHistory();
        } else if (sectionId === 'history') {
            loadSellHistory();
        }
    }

    // üîπ Filter & Sort Logic
    window.filterVehicles = () => {
      const vehicleGridElement = document.getElementById("vehicleGrid");
      const cards = Array.from(vehicleGridElement.children);
      
      const search = document.getElementById('search').value.toLowerCase();
      const type = document.getElementById('filter').value;
      const sortBy = document.getElementById('sort').value;

      // 1. FILTERING
      cards.forEach(card => {
        const matchesSearch = !search || 
                              card.dataset.name.toLowerCase().includes(search) ||
                              card.dataset.year.includes(search) ||
                              card.dataset.km.includes(search) ||
                              card.dataset.price.includes(search);

        const matchesType = (type === 'all' || card.dataset.type === type);

        card.style.display = (matchesSearch && matchesType) ? "grid" : "none";
      });

      let visibleCards = cards.filter(card => card.style.display !== 'none');

      // 2. SORTING
      visibleCards.sort((a, b) => {
        const aVal = a.dataset[sortBy.split('_')[0]];
        const bVal = b.dataset[sortBy.split('_')[0]];
        const direction = sortBy.split('_')[1];

        if (sortBy === 'default') return 0;

        if (sortBy.includes('year') || sortBy.includes('km') || sortBy.includes('price')) {
          const numA = parseFloat(aVal);
          const numB = parseFloat(bVal);
          if (direction === 'asc') return numA - numB;
          return numB - numA;
        }

        if (sortBy.includes('name')) {
          const nameA = aVal.toLowerCase();
          const nameB = bVal.toLowerCase();
          if (direction === 'asc') return nameA.localeCompare(nameB);
          return nameB.localeCompare(nameA);
        }

        return 0;
      });

      // 3. RE-RENDERING 
      visibleCards.forEach(card => {
        vehicleGridElement.appendChild(card);
        card.style.display = 'grid'; 
      });
    };

    // Set initial view
    document.addEventListener('DOMContentLoaded', () => {
        showSection('home');
        hideLoader(); // Ensure loader is hidden on load
        
        document.getElementById('modalDownPayment')?.addEventListener('input', window.updateEMICalculation);
        document.getElementById('modalLoanTenure')?.addEventListener('change', window.updateEMICalculation);
        document.getElementById('modalInterestRate')?.addEventListener('change', window.updateEMICalculation);
        document.getElementById('modalPaymentOption')?.addEventListener('change', window.updateEMICalculation);

        document.getElementById('search')?.addEventListener('input', window.filterVehicles);
        document.getElementById('filter')?.addEventListener('change', window.filterVehicles);
        document.getElementById('sort')?.addEventListener('change', window.filterVehicles);
    });
  </script>
  <style>
    /* ... (CSS STYLES REMAIN UNCHANGED) ... */
    :root {
      --primary-color: #00796B;
      --primary-hover: #00695C;
      --background-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #212529;
      --text-light: #6c757d;
      --border-color: #e9ecef;
      --danger-color: #dc3545;
      --success-bg: #4caf50;
      --error-bg: #f44336;
      --warning-bg: #ff9800;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--background-color);
      margin: 0;
      padding-top: 60px; /* Space for fixed header */
      color: var(--text-color);
    }
    /* --- LOADER BAR (NEW) --- */
    #loader-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: transparent;
      z-index: 10002;
      overflow: hidden;
    }
    #loader-bar::after {
      content: '';
      display: block;
      height: 100%;
      width: 30%; /* Start width */
      background-color: var(--danger-color); /* Highlight color */
      animation: progress-slide 1.5s infinite linear;
    }
    @keyframes progress-slide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(333.33%); } /* 100 / 30 * 100 % */
    }

    /* --- TOAST NOTIFICATION (NEW) --- */
    #toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10001;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    .toast {
        background-color: #333;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        opacity: 1;
        transition: opacity 0.5s, transform 0.5s;
        min-width: 250px;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
    }
    .toast.success { background-color: var(--success-bg); }
    .toast.error { background-color: var(--error-bg); }
    .toast.warning { background-color: var(--warning-bg); }
    .toast.fade-out {
        opacity: 0;
        transform: translate(-50%, -20px);
    }

    /* --- HEADER --- */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 10000;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 700;
      letter-spacing: 1px;
    }
    #drawer-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      margin-right: 15px;
      cursor: pointer;
      padding: 5px;
    }
    .header-right {
      display: flex;
      align-items: center;
    }
    .cart-icon {
      font-size: 20px;
      cursor: pointer;
      position: relative;
      padding: 5px;
    }
    .cart-badge {
      position: absolute;
      top: -5px;
      right: -10px;
      background: var(--danger-color);
      color: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1;
    }

    /* --- DRAWER MENU --- */
    #drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9998;
      display: none;
      transition: opacity 0.3s;
    }
    #drawer-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background: var(--card-bg);
      z-index: 9999;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    #drawer-menu.open {
      transform: translateX(0);
    }
    .drawer-header {
      text-align: right;
      margin-bottom: 20px;
    }
    .drawer-header button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-light);
    }
    .drawer-profile {
      text-align: center;
      padding-bottom: 20px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    .drawer-profile img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 10px;
    }
    .drawer-profile h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    .drawer-profile p {
      margin: 0;
      font-size: 13px;
      color: var(--text-light);
    }
    .drawer-nav {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .drawer-nav .nav-item {
      padding: 12px 15px;
      text-decoration: none;
      color: var(--text-color);
      font-size: 16px;
      display: flex;
      align-items: center;
      transition: background 0.2s;
      border-radius: 6px;
    }
    .drawer-nav .nav-item:hover, .drawer-nav .nav-item.active {
      background: var(--border-color);
    }
    .drawer-nav .nav-item .icon {
      margin-right: 15px;
      font-size: 18px;
    }
    .drawer-logout-btn {
      background: var(--danger-color);
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .drawer-logout-btn:hover {
      background: #c82333;
    }
    main {
      padding: 0 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* --- CONTENT SECTIONS --- */
    .content-section {
      padding-top: 20px;
      min-height: calc(100vh - 80px); /* Fill the viewport */
    }
    .content-section.hidden {
      display: none;
    }
    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    /* Search & Filter Bar */
    .search-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      margin-top: 15px;
    }
    .search-filter input, .search-filter select {
      padding: 10px 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
    }
    .search-filter input {
      flex-grow: 1;
    }
    .search-filter select {
      width: 150px;
      flex-shrink: 0;
    }

    /* Vehicle Grid */
    #vehicleGrid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    /* Vehicle Card */
    .card {
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    .card-image {
      width: 100%;
      height: 180px;
      background-size: cover;
      background-position: center;
      border-bottom: 1px solid var(--border-color);
    }
    .card-content {
      padding: 18px;
    }
    .card-content h3 {
      margin: 0 0 8px 0;
      color: var(--text-color);
      font-size: 18px;
      font-weight: 600;
    }
    .card-content .specs {
      color: var(--text-light);
      margin: 5px 0 10px 0;
      font-size: 14px;
    }
    .card-content .specs span {
      font-weight: 500;
      color: var(--text-color);
    }
    .card-content .description {
      font-size: 14px;
      color: var(--text-color);
      margin-bottom: 15px;
      line-height: 1.4;
    }
    .card-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
    }
    .card-actions .price {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    .cart-btn, .buy-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    .cart-btn {
      background: var(--warning-bg);
      color: var(--text-color);
    }
    .cart-btn:hover {
      background: #e08e00;
    }
    .buy-btn {
      background: var(--success-bg);
      color: white;
    }
    .buy-btn:hover {
      background: #388e3c;
    }

    /* --- SELL VIEW --- */
    .sell-form-container {
      max-width: 600px;
      margin: 0 auto 40px auto;
      background: var(--card-bg);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group.split {
        display: flex;
        gap: 20px;
    }
    .form-group.split > div {
        flex: 1;
    }
    .sell-form-container label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .sell-form-container input[type="text"], 
    .sell-form-container input[type="email"],
    .sell-form-container input[type="number"], 
    .sell-form-container textarea,
    .sell-form-container select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
    }
    .sell-form-container textarea {
      resize: vertical;
      min-height: 100px;
    }
    .sell-form-container button {
      background: var(--danger-color);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }
    .sell-form-container button:hover {
      background: #c82333;
    }
    .full-width {
      width: 100%;
    }
    .note {
      display: block;
      font-size: 12px;
      color: var(--text-light);
      margin-top: 5px;
    }

    /* Image Previews */
    .preview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .preview-wrapper {
      position: relative;
      width: 100px;
      height: 100px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }
    .preview-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .preview-remove {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      line-height: 1;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 0;
    }
    .preview-kind {
      position: absolute;
      bottom: 2px;
      left: 2px;
      background: rgba(255,255,255,0.9);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      color: var(--text-light);
      font-weight: 700;
      text-transform: uppercase;
    }

    /* --- SELL HISTORY / ORDERS TABLE STYLES --- */
    .table-container {
        overflow-x: auto;
        margin-bottom: 40px;
    }
    .history-table, .orders-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .history-table th, .orders-table th {
        background: var(--primary-color);
        color: white;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
    }
    .history-table td, .orders-table td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
    }
    .history-table tr:last-child td, .orders-table tr:last-child td {
        border-bottom: none;
    }
    .history-table tbody tr:hover, .orders-table tbody tr:hover {
        background: #f7f7f7;
    }
    .status-badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        text-transform: capitalize;
    }
    .status-badge.approved { background: #e6ffed; color: #008744; } /* Green */
    .status-badge.pending { background: #fff5e6; color: #ff9800; } /* Amber */
    .status-badge.rejected { background: #ffe6e6; color: var(--danger-color); } /* Red */
    .action-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .action-btn:hover {
        background: var(--primary-hover);
    }

    /* --- PROFILE VIEW --- */
    .profile-card {
        max-width: 600px;
        margin: 0 auto 40px auto;
        background: var(--card-bg);
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .profile-summary {
        display: flex;
        align-items: center;
        padding-bottom: 20px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
    }
    .profile-summary img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 20px;
    }
    .profile-details h3 {
        margin: 0 0 5px 0;
        font-size: 20px;
        font-weight: 700;
    }
    .profile-details p {
        margin: 5px 0;
        font-size: 14px;
        color: var(--text-color);
    }
    .profile-details span {
        font-weight: 500;
        color: var(--text-light);
    }
    .profile-form label {
        display: block;
        font-weight: 600;
        margin-top: 15px;
        margin-bottom: 5px;
        font-size: 14px;
    }
    .profile-form input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 16px;
    }
    .profile-form button {
        background: var(--primary-color);
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        margin-top: 20px;
        width: 100%;
    }
    .profile-form button:hover {
        background: var(--primary-hover);
    }

    /* --- CART VIEW --- */
    .cart-container {
        display: flex;
        gap: 20px;
        margin-bottom: 40px;
        align-items: flex-start;
    }
    .cart-list {
        flex: 3;
        background: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .cart-summary {
        flex: 1;
        background: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        position: sticky;
        top: 80px; /* Offset from fixed header */
    }
    .cart-summary h3 {
        margin-top: 0;
        font-size: 20px;
    }
    .total-price-text {
        display: flex;
        justify-content: space-between;
        font-size: 16px;
        font-weight: 500;
        margin: 8px 0;
    }
    .total-price-text span {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 20px;
    }
    .cart-summary button {
        width: 100%;
        background: var(--success-bg);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 20px;
        transition: background 0.2s;
    }
    .cart-summary button:hover:not(:disabled) {
        background: #388e3c;
    }
    .cart-summary button:disabled {
        background: #cccccc;
        cursor: not-allowed;
    }
    .empty-state {
        text-align: center;
        color: var(--text-light);
        padding: 50px 0;
        font-size: 16px;
    }

    /* Cart Item Card */
    .cart-item-card {
        display: flex;
        align-items: center;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .cart-item-card:last-child {
        border-bottom: none;
    }
    .cart-item-card .item-image {
        width: 80px;
        height: 60px;
        background-size: cover;
        background-position: center;
        border-radius: 6px;
        flex-shrink: 0;
        margin-right: 15px;
    }
    .cart-item-card .item-details {
        flex-grow: 1;
    }
    .cart-item-card .item-details h3 {
        margin: 0 0 5px 0;
        font-size: 16px;
        font-weight: 600;
    }
    .cart-item-card .item-details .item-specs {
        font-size: 12px;
        color: var(--text-light);
        margin: 0;
    }
    .cart-item-card .item-price {
        font-size: 18px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0 20px;
        flex-shrink: 0;
    }
    .cart-item-card .item-actions .remove-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        transition: background 0.2s;
    }
    .cart-item-card .item-actions .remove-btn:hover {
        background: #c82333;
    }

    /* --- MEDIA QUERIES --- */
    @media (max-width: 900px) {
        .cart-container {
            flex-direction: column;
        }
        .cart-summary {
            width: 100%;
            position: static; /* Remove sticky on small screens */
        }
        .search-filter {
            flex-direction: column;
        }
        .search-filter select {
            width: 100%;
        }
    }
    @media (max-width: 600px) {
        main {
            padding: 0 10px;
        }
        .card {
            max-width: 100%;
        }
        .drawer-menu {
            width: 80%;
        }
        .cart-summary {
            position: static;
            top: 0;
        }
        .cart-item-card {
            flex-wrap: wrap;
        }
        .cart-item-card .item-price {
            order: 1;
            width: 100%;
            margin: 10px 0 0 0;
            text-align: right;
        }
        .cart-item-card .item-actions {
            order: 2;
        }
        .cart-item-card .item-image {
            order: 3;
        }
        .cart-item-card .item-details {
            order: 4;
        }
        /* Tables (History/Orders) */
        .history-table thead, .orders-table thead {
            display: none;
        }
        .history-table tr, .orders-table tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .history-table td, .orders-table td {
            display: block;
            text-align: right;
            padding-left: 50%;
            position: relative;
            border-bottom: 1px dotted var(--border-color);
        }
        .history-table tr:last-child td, .orders-table tr:last-child td {
            border-bottom: 1px dotted var(--border-color); /* Re-add the separator */
        }
        .history-table tr:last-child td:last-child, .orders-table tr:last-child td:last-child {
            border-bottom: none;
        }
        .history-table td::before, .orders-table td::before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            font-weight: 600;
            color: var(--primary-color);
            text-align: left;
        }
    }

    /* --- BUY NOW MODAL STYLES --- */
    #buyNowOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 10005;
        display: none;
    }
    .buy-now-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 90%;
        max-width: 550px;
        background: var(--card-bg);
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        z-index: 10006;
        opacity: 0;
        visibility: hidden;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    .buy-now-modal.open {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border-color);
    }
    .modal-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
    }
    .modal-header button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-light);
    }
    .modal-content {
        padding: 20px;
    }
    .modal-price {
        text-align: center;
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 20px;
    }
    .modal-price span {
        font-size: 28px;
        font-weight: 700;
        color: var(--danger-color);
        display: block;
        margin-top: 5px;
    }
    .loan-arrangement-section {
        border: 1px dashed var(--border-color);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .loan-arrangement-section h4 {
        margin: 0 0 15px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--primary-color);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }
    .input-group-modal {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }
    .input-group-modal > div {
        flex: 1;
    }
    .input-group-modal label {
        display: block;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 5px;
        color: var(--text-light);
    }
    .input-group-modal input, .input-group-modal select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 15px;
    }
    .emi-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        font-size: 16px;
        font-weight: 500;
    }
    .emi-summary h4 {
        margin: 0;
        font-size: 18px;
        color: var(--text-color);
        font-weight: 600;
    }
    .emi-value {
        font-size: 22px;
        color: var(--danger-color);
        font-weight: 700;
    }
    .modal-footer {
        border-top: 1px solid var(--border-color);
        padding-top: 15px;
    }
    #modalConfirmOrder {
        width: 100%;
        padding: 12px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s;
    }
    #modalConfirmOrder:hover {
        background: var(--primary-hover);
    }
    .modal-note {
        text-align: center;
        margin-top: 15px;
        font-size: 13px;
        color: var(--text-light);
    }
    .modal-note a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
    }

    /* Responsive adjustments for modal */
    @media (max-width: 550px) {
        .buy-now-modal {
            width: 95%;
        }
        .input-group-modal {
            flex-direction: column;
        }
    }
  </style>
</head>
<body>
  <div id="loader-bar"></div>
  <div id="toast-container"></div>
  
  <div id="buyNowOverlay" onclick="closeBuyNowModal()"></div>
  <div id="buyNowModal" class="buy-now-modal" data-vehicle-key="" data-vehicle-name="" data-vehicle-price="0">
      <div class="modal-header">
          <h3 id="modalVehicleName">Confirm Purchase</h3>
          <button onclick="closeBuyNowModal()">‚úï</button>
      </div>
      <div class="modal-content">
          <div class="modal-price">
              Total Vehicle Price: <span id="modalVehiclePrice">‚Çπ0</span>
          </div>

          <div class="input-group-modal full-width" style="margin-bottom: 20px;">
              <label for="modalPaymentOption">Select Payment Option</label>
              <select id="modalPaymentOption" onchange="window.updateEMICalculation()">
                  <option value="full_paid">Full Paid (Cash/Bank Transfer)</option>
                  <option value="emi">EMI / Loan Arrangement</option>
              </select>
          </div>

          <div id="emiArrangementSection" class="loan-arrangement-section">
              <h4>Loan / EMI Arrangement</h4>
              <div class="input-group-modal">
                  <div>
                      <label for="modalDownPayment">Down Payment (‚Çπ)</label>
                      <input type="number" id="modalDownPayment" value="0" min="0" required>
                  </div>
                  <div>
                      <label for="modalLoanTenure">Loan Tenure (Months)</label>
                      <select id="modalLoanTenure">
                          <option value="12">12 Months (1 Year)</option>
                          <option value="24">24 Months (2 Years)</option>
                          <option value="36">36 Months (3 Years)</option>
                          <option value="48">48 Months (4 Years)</option>
                      </select>
                  </div>
              </div>
              <div class="input-group-modal">
                  <div>
                      <label for="modalInterestRate">Annual Interest Rate (%)</label>
                      <select id="modalInterestRate">
                          <option value="10">10.0%</option>
                          <option value="12">12.0%</option>
                          <option value="14">14.0%</option>
                          <option value="16">16.0%</option>
                      </select>
                  </div>
                  <div>
                      <label>Loan Amount Remaining (‚Çπ)</label>
                      <span id="modalLoanAmountDisplay" class="input-display">‚Çπ0</span>
                  </div>
              </div>

              <div class="emi-summary">
                  <h4>Estimated Monthly EMI</h4>
                  <span id="modalMonthlyEMI" class="emi-value">‚Çπ0</span>
              </div>
          </div>
          
          <div class="modal-footer">
              <button id="modalConfirmOrder" onclick="confirmBuyNow()">Confirm Cash Order</button>
              <p class="modal-note">By confirming, you agree to our <a href="#" onclick="showToast('Terms & Conditions not implemented yet.', 'warning')">Terms & Conditions</a>.</p>
          </div>
      </div>
  </div>
  <div id="drawer-menu">
    <div class="drawer-header">
      <button onclick="toggleDrawer()">‚úï</button>
    </div>
    <div class="drawer-profile">
      <img id="userPhotoDrawer" src="https://static-00.iconduck.com/assets.00/user-avatar-icon-512x512-nghi2896.png" alt="User Photo" />
      <h3 id="userNameDrawer">Guest User</h3>
      <p id="userEmailDrawer">Please log in</p>
    </div>
    <div class="drawer-nav">
      <a href="#" class="nav-item active" data-section="home" onclick="showSection('home')">
        <span class="icon">üè†</span> Home
      </a>
      <a href="#" class="nav-item" data-section="cart" onclick="showSection('cart')">
        <span class="icon">üõí</span> Cart (<span id="cart-count-drawer">0</span>)
      </a>
      <a href="#" class="nav-item" data-section="order" onclick="showSection('order')">
        <span class="icon">üì¶</span> My Orders
      </a>
      <a href="#" class="nav-item" data-section="sell" onclick="showSection('sell')">
        <span class="icon">üí∞</span> Sell Vehicle
      </a>
      <a href="#" class="nav-item" data-section="history" onclick="showSection('history')">
        <span class="icon">üìú</span> Selling History
      </a>
      <a href="#" class="nav-item" data-section="profile" onclick="showSection('profile')">
        <span class="icon">üë§</span> Profile
      </a>
    </div>
    <button class="drawer-logout-btn" onclick="logout()">Logout</button>
  </div>

  <div id="drawer-overlay" onclick="toggleDrawer()"></div>

  <header>
    <div class="header-left">
      <button id="drawer-toggle" onclick="toggleDrawer()">‚ò∞</button>
      <h1>JD MotoHub</h1>
    </div>
    <div class="header-right">
      <div class="cart-icon" onclick="showSection('cart')">
        üõí
        <span id="cart-count" class="cart-badge">0</span>
      </div>
    </div>
  </header>

  <main>
    <div id="home-view" class="content-section">
      <h2 class="section-title">Available Vehicles</h2>
      <div class="search-filter">
        <input type="text" placeholder="Search by name, year, km, or price..." id="search">
        <select id="filter">
          <option value="all">All Vehicles</option>
          <option value="bike">Bikes</option>
          <option value="car">Cars</option>
        </select>
        <select id="sort">
          <option value="default">Default Sort</option>
          <option value="name_asc">Name (A-Z)</option>
          <option value="name_desc">Name (Z-A)</option>
          <option value="year_desc">Year (Newest)</option>
          <option value="year_asc">Year (Oldest)</option>
          <option value="km_asc">Kilometers (Low to High)</option>
          <option value="km_desc">Kilometers (High to Low)</option>
          <option value="price_asc">Price (Low to High)</option>
          <option value="price_desc">Price (High to Low)</option>
        </select>
      </div>
      <div id="vehicleGrid">
        </div>
    </div>

    <div id="cart-view" class="content-section hidden">
      <h2 class="section-title">Your Shopping Cart (<span id="cart-count-display">0</span> Items)</h2>
      <div class="cart-container">
        <div class="cart-list" id="cartItemsList">
          </div>
        <div class="cart-summary" id="cartSummary">
          <h3>Order Summary</h3>
          <button id="checkoutButton" onclick="checkoutCart()" disabled>Proceed to Checkout</button>
        </div>
      </div>
    </div>

    <div id="order-view" class="content-section hidden">
      <h2 class="section-title">Your Order History</h2>
      <div class="table-container">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Vehicle</th>
              <th>Price</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
            </tbody>
        </table>
      </div>
    </div>

    <div id="sell-view" class="content-section hidden">
      <h2 class="section-title">Sell Your Vehicle</h2>
      <div class="sell-form-container">
        <form onsubmit="event.preventDefault(); addVehicle();">
          <h3>Seller Details</h3>
          <div class="form-group">
            <label for="sellername">Full Name *</label>
            <input type="text" id="sellername" required>
          </div>
          <div class="form-group">
            <label for="selleremail">Email Address *</label>
            <input type="email" id="selleremail" required readonly>
          </div>
          <div class="form-group split">
            <div>
                <label for="sellerphone">Mobile Number *</label>
                <input type="text" id="sellerphone" required pattern="[0-9]{10,15}" title="10 to 15 digits">
                <span class="note">Required for order processing/verification.</span>
            </div>
            <div>
                <label for="selleraltphone">Alternate Phone</label>
                <input type="text" id="selleraltphone" pattern="[0-9]{0,15}">
            </div>
          </div>
          <div class="form-group">
            <label for="selleraddress">Your Address *</label>
            <textarea id="selleraddress" rows="3" required></textarea>
          </div>

          <hr style="margin: 30px 0;">

          <h3>Vehicle Details</h3>
          <div class="form-group">
            <label for="vname">Vehicle Name/Model *</label>
            <input type="text" id="vname" required>
          </div>
          <div class="form-group">
            <label for="vdescription">Description *</label>
            <textarea id="vdescription" rows="4" required placeholder="Describe the condition, features, and history of the vehicle."></textarea>
          </div>
          <div class="form-group split">
            <div>
                <label for="vtype">Type *</label>
                <select id="vtype" required>
                  <option value="bike">Bike</option>
                  <option value="car">Car</option>
                </select>
            </div>
            <div>
                <label for="vyear">Year of Manufacture *</label>
                <input type="number" id="vyear" required min="1990" max="2024">
            </div>
          </div>
          <div class="form-group split">
            <div>
                <label for="vkm">Kilometers Driven *</label>
                <input type="number" id="vkm" required min="1" step="1">
            </div>
            <div>
                <label for="vprice">Your Expected Selling Price (‚Çπ) *</label>
                <input type="number" id="vprice" required min="1000" step="100">
            </div>
          </div>
          
          <hr style="margin: 30px 0;">

          <h3>Vehicle Images</h3>
          <div class="form-group">
            <label for="vimages">Upload Images (Max 5 files)</label>
            <input type="file" id="vfileinput" accept="image/*" multiple onchange="handleFileSelection(event)">
            <span class="note">Upload photos from your computer/phone (converted to link internally).</span>
          </div>
          <div class="form-group">
            <label for="vimages">Or Add Image URLs (comma-separated)</label>
            <input type="text" id="vimages" placeholder="https://example.com/img1.jpg, https://example.com/img2.jpg">
            <button type="button" class="full-width" onclick="addImageURLsToSelection()">Add URLs to Selection</button>
            <span class="note">Ensure URLs are directly accessible image files.</span>
          </div>
          <div class="form-group">
            <label>Image Previews</label>
            <div id="imagePreviewContainer" class="preview-grid">
              </div>
          </div>

          <button type="submit" style="margin-top: 20px;">Submit for Approval</button>
        </form>
      </div>
    </div>
    
    <div id="history-view" class="content-section hidden">
      <h2 class="section-title">Your Selling History</h2>
      <div class="table-container">
        <table class="history-table">
          <thead>
            <tr>
              <th>Vehicle Name</th>
              <th>Type</th>
              <th>Your Quoted Price</th>
              <th>Final Selling Price</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            </tbody>
        </table>
      </div>
    </div>

    <div id="profile-view" class="content-section hidden">
      <h2 class="section-title">Your Profile</h2>
      <div class="profile-card">
        <div class="profile-summary">
            <img id="userPhotoProfile" src="https://static-00.iconduck.com/assets.00/user-avatar-icon-512x512-nghi2896.png" alt="User Photo" />
            <div class="profile-details">
                <h3 id="userNameProfile"></h3>
                <p>Email: <span id="userEmailProfile"></span></p>
                <p>Mobile No: <span id="userPhoneProfile"></span></p>
                <p>Address: <span id="userAddressProfile"></span></p>
            </div>
        </div>
        <div class="profile-form">
          <h3>Update Information</h3>
          <label for="profile-input-name">Full Name</label>
          <input type="text" id="profile-input-name" required>
          <label for="profile-input-email">Email Address (Read-only)</label>
          <input type="email" id="profile-input-email" readonly style="background: #f0f0f0; color: #a0a0a0;">
          <label for="profile-input-phone">Mobile Number</label>
          <input type="text" id="profile-input-phone" required pattern="[0-9]{10,15}" title="10 to 15 digits">
          <span class="note">Required for placing orders.</span>
          <label for="profile-input-address">Address</label>
          <input type="text" id="profile-input-address">

          <button onclick="updateUserProfile()">Update Profile</button>
        </div>
      </div>
    </div>

  </main>
</body>
</html>
